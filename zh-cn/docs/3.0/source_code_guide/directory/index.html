<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=本文介绍了服务目录的原理和实现细节><link rel="shortcut icon" href=../../../../assets/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.0.2"><title>服务目录 - Apache Dubbo</title><link rel=stylesheet href=../../../../assets/stylesheets/main.38780c08.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.3f72e892.min.css><meta name=theme-color content=#4051b5><link rel=stylesheet href=../../../../css/dropdown.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Application header --> <header class=md-header data-md-component=header> <!-- Top-level navigation --> <nav class="md-header-nav md-grid" aria-label=Header> <!-- Link to home --> <a href=../../../.. title="Apache Dubbo" class="md-header-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"><path d="M3.136 17.387v42.932l42.932 21.467L3.136 17.387z"/><path fill-opacity=.5 d="M21.91 8l42.933 64.398-18.775 9.388L3.136 17.387 21.91 8z"/><path d="M67.535 17.387L40.273 35.543l21.878 32.818 5.384 2.691V17.387z"/><path fill-opacity=.25 d="M67.535 17.387v53.666l18.774-9.388V8l-18.774 9.387z"/></svg> </a> <!-- Button to open drawer --> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <!-- Header title --> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Apache Dubbo </span> <span class="md-header-nav__topic md-ellipsis"> 服务目录 </span> </div> </div> <!-- Button to open search dialogue --> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div> <div class=langChange id=translate title=中文|English> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"> <path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"/> </svg> </div> <script>
    var translate = document.getElementById('translate');
    translate.addEventListener('click', changeHref, false);
    function changeHref() {
        if (window.location.href.search('en-us') !== -1) {
            var changeHref = window.location.href.replace('en-us', 'zh-cn');

        } else {
            var changeHref = window.location.href.replace('zh-cn', 'en-us');
        }
        window.location.href = changeHref
    }
</script> <style>
    .langChange {
        display: inline-block;
        width: 2.4rem;
        height: 2.4rem;
        vertical-align: middle;
        margin-left: .5rem;
    }

    .langChange svg {
        fill: rgba(255, 255, 255, 0.548);
        display: block;
        width: 1.2rem;
        height: 1.2rem;
        margin: 0 auto;
        margin-top: .6rem;
        margin-left: .6rem;
    }

    .langChange :hover {
        fill: white;
        cursor: pointer;
    }
</style> </div> <!-- Repository containing source --> <div class=md-header-nav__source> <a href=https://github.com/apache/dubbo/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Main navigation --> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <!-- Site title --> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Apache Dubbo" class="md-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"><path d="M3.136 17.387v42.932l42.932 21.467L3.136 17.387z"/><path fill-opacity=.5 d="M21.91 8l42.933 64.398-18.775 9.388L3.136 17.387 21.91 8z"/><path d="M67.535 17.387L40.273 35.543l21.878 32.818 5.384 2.691V17.387z"/><path fill-opacity=.25 d="M67.535 17.387v53.666l18.774-9.388V8l-18.774 9.387z"/></svg> </a> Apache Dubbo </label> <!-- Repository containing source --> <div class=md-nav__source> <a href=https://github.com/apache/dubbo/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <!-- Render item list --> <ul class=md-nav__list data-md-scrollfix> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../.. title=首页 class=md-nav__link> 首页 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 2.7 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=2.7 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 2.7 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1> 用户手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=用户手册 data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 用户手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1 type=checkbox id=nav-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1> 入门 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=入门 data-md-level=3> <label class=md-nav__title for=nav-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 入门 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/background/ title=背景 class=md-nav__link> 背景 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/requirements/ title=需求 class=md-nav__link> 需求 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/architecture/ title=架构 class=md-nav__link> 架构 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/usage/ title=用法 class=md-nav__link> 用法 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/quick-start/ title=快速启动 class=md-nav__link> 快速启动 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/dependencies/ title=依赖 class=md-nav__link> 依赖 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/maturity/ title=成熟度 class=md-nav__link> 成熟度 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-5 type=checkbox id=nav-1-1-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-5> 配置 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=配置 data-md-level=3> <label class=md-nav__title for=nav-1-1-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 配置 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/xml/ title="XML 配置" class=md-nav__link> XML 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/api/ title="API 配置" class=md-nav__link> API 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/annotation/ title="Annotation 配置" class=md-nav__link> Annotation 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/annotation/ title=动态配置中心 class=md-nav__link> 动态配置中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/configuration-load-process/ title=配置加载流程 class=md-nav__link> 配置加载流程 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/environment-variables/ title=自动加载环境变量 class=md-nav__link> 自动加载环境变量 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-6 type=checkbox id=nav-1-1-6> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-6> 示例 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=示例 data-md-level=3> <label class=md-nav__title for=nav-1-1-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 示例 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/preflight-check/ title=启动时检查 class=md-nav__link> 启动时检查 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/fault-tolerent-strategy/ title=集群容错 class=md-nav__link> 集群容错 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/loadbalance/ title=负载均衡 class=md-nav__link> 负载均衡 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/thread-model/ title=线程模型 class=md-nav__link> 线程模型 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/explicit-target/ title=直连提供者 class=md-nav__link> 直连提供者 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/subscribe-only/ title=只订阅 class=md-nav__link> 只订阅 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/registry-only/ title=只注册 class=md-nav__link> 只注册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/static-service/ title=静态服务 class=md-nav__link> 静态服务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-protocols/ title=多协议 class=md-nav__link> 多协议 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-registry/ title=多注册中心 class=md-nav__link> 多注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-group/ title=服务分组 class=md-nav__link> 服务分组 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-versions/ title=多版本 class=md-nav__link> 多版本 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/group-merger/ title=分组聚合 class=md-nav__link> 分组聚合 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/parameter-validation/ title=参数验证 class=md-nav__link> 参数验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/result-cache/ title=结果缓存 class=md-nav__link> 结果缓存 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/generic-reference/ title=泛化引用 class=md-nav__link> 泛化引用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/generic-service/ title=泛化实现 class=md-nav__link> 泛化实现 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/echo-service/ title=回声测试 class=md-nav__link> 回声测试 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/context/ title=上下文信息 class=md-nav__link> 上下文信息 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/attachment/ title=隐式参数 class=md-nav__link> 隐式参数 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/async-call/ title=异步调用 class=md-nav__link> 异步调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/async-execute-on-provider/ title=服务端异步 class=md-nav__link> 服务端异步 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-call/ title=本地调用 class=md-nav__link> 本地调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/callback-parameter/ title=参数回调 class=md-nav__link> 参数回调 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/events-notify/ title=事件通知 class=md-nav__link> 事件通知 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-stub/ title=本地存根 class=md-nav__link> 本地存根 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-mock/ title=本地伪装 class=md-nav__link> 本地伪装 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/delay-publish/ title=延迟暴露 class=md-nav__link> 延迟暴露 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/concurrency-control/ title=并发控制 class=md-nav__link> 并发控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/config-connection.md title=连接控制 class=md-nav__link> 连接控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/lazy-connect/ title=延迟连接 class=md-nav__link> 延迟连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/stickiness/ title=粘滞连接 class=md-nav__link> 粘滞连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/token-authorization/ title=令牌验证 class=md-nav__link> 令牌验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/routing-rule/ title=路由规则 class=md-nav__link> 路由规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/config-rule/ title=配置规则 class=md-nav__link> 配置规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-downgrade/ title=服务降级 class=md-nav__link> 服务降级 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/graceful-shutdown/ title=优雅停机 class=md-nav__link> 优雅停机 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/hostname-binding/ title=主机绑定 class=md-nav__link> 主机绑定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/logger-strategy/ title=日志适配 class=md-nav__link> 日志适配 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/accesslog/ title=访问日志 class=md-nav__link> 访问日志 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-container/ title=服务容器 class=md-nav__link> 服务容器 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/distributed-transaction/ title=分布式事务 class=md-nav__link> 分布式事务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/dump/ title=线程栈自动dump class=md-nav__link> 线程栈自动dump </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/netty4/ title=Netty4 class=md-nav__link> Netty4 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/serialization/ title=Kryo和FST序列化 class=md-nav__link> Kryo和FST序列化 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/simplify-registry-data/ title=简化注册中心URL class=md-nav__link> 简化注册中心URL </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/api.md title="API 参考手册" class=md-nav__link> API 参考手册 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-7 type=checkbox id=nav-1-1-7> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-7> schema 配置参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="schema 配置参考手册" data-md-level=3> <label class=md-nav__title for=nav-1-1-7> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> schema 配置参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-service/ title=dubbo:service class=md-nav__link> dubbo:service </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-reference/ title=dubbo:reference class=md-nav__link> dubbo:reference </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-protocol/ title=dubbo:protocol class=md-nav__link> dubbo:protocol </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-registry/ title=dubbo:registry class=md-nav__link> dubbo:registry </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-monitor/ title=dubbo:monitor class=md-nav__link> dubbo:monitor </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-application/ title=dubbo:application class=md-nav__link> dubbo:application </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-module/ title=dubbo:module class=md-nav__link> dubbo:module </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-provider/ title=dubbo:provider class=md-nav__link> dubbo:provider </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-consumer/ title=dubbo:consumer class=md-nav__link> dubbo:consumer </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-method/ title=dubbo:method class=md-nav__link> dubbo:method </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-argument/ title=dubbo:argument class=md-nav__link> dubbo:argument </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-parameter/ title=dubbo:parameter class=md-nav__link> dubbo:parameter </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-config-center/ title=dubbo:config-center class=md-nav__link> dubbo:config-center </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-8 type=checkbox id=nav-1-1-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-8> 协议参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=协议参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 协议参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/dubbo/ title=dubbo:// class=md-nav__link> dubbo:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/rmi/ title=rmi:// class=md-nav__link> rmi:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/hessian/ title=hessian:// class=md-nav__link> hessian:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/http/ title=http:// class=md-nav__link> http:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/thrift/ title=thrift:// class=md-nav__link> thrift:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/rest/ title=rest:// class=md-nav__link> rest:// </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-9 type=checkbox id=nav-1-1-9> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-9> 注册中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=注册中心参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-9> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 注册中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/multicast/ title="Multicast 注册中心" class=md-nav__link> Multicast 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/zookeeper/ title="Zookeeper 注册中心" class=md-nav__link> Zookeeper 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/redis/ title="Redis 注册中心" class=md-nav__link> Redis 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/simple/ title="Simple 注册中心" class=md-nav__link> Simple 注册中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-10 type=checkbox id=nav-1-1-10> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-10> 元数据中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=元数据中心参考手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-10> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 元数据中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/metadata/metadata-redis/ title="Redis 元数据中心" class=md-nav__link> Redis 元数据中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/metadata/metadata-zookeeper/ title="Zookeeper 元数据中心" class=md-nav__link> Zookeeper 元数据中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/telnet/ title="telnet 命令参考手册" class=md-nav__link> telnet 命令参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/qos/ title=在线运维命令-QOS class=md-nav__link> 在线运维命令-QOS </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/maven/ title="maven 插件参考手册" class=md-nav__link> maven 插件参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/best-practice/ title=服务化最佳实践 class=md-nav__link> 服务化最佳实践 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/recommend/ title=推荐用法 class=md-nav__link> 推荐用法 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/capacity-plan/ title=容量规划 class=md-nav__link> 容量规划 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/perf-test/ title=性能测试报告 class=md-nav__link> 性能测试报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/covergence.md title=测试覆盖率报告 class=md-nav__link> 测试覆盖率报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-19 type=checkbox id=nav-1-1-19> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-19> 版本与升级 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=版本与升级 data-md-level=3> <label class=md-nav__title for=nav-1-1-19> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 版本与升级 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/versions/version-270/ title=2.7.x升级步骤及注意事项 class=md-nav__link> 2.7.x升级步骤及注意事项 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2> 开发手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发手册 data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/build.md title=源码构建 class=md-nav__link> 源码构建 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/design.md title=框架设计 class=md-nav__link> 框架设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/SPI.md title=扩展点加载 class=md-nav__link> 扩展点加载 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/implementation.md title=实现细节 class=md-nav__link> 实现细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-5 type=checkbox id=nav-1-2-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-5> SPI 扩展实现 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="SPI 扩展实现" data-md-level=3> <label class=md-nav__title for=nav-1-2-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> SPI 扩展实现 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/protocol.md title=协议扩展 class=md-nav__link> 协议扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/filter.md title=调用拦截扩展 class=md-nav__link> 调用拦截扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/invoker-listener.md title=引用监听扩展 class=md-nav__link> 引用监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exporter-listener.md title=暴露监听扩展 class=md-nav__link> 暴露监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cluster.md title=集群扩展 class=md-nav__link> 集群扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/router.md title=路由扩展 class=md-nav__link> 路由扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/load-balance.md title=负载均衡扩展 class=md-nav__link> 负载均衡扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/merger.md title=合并结果扩展 class=md-nav__link> 合并结果扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/registry.md title=注册中心扩展 class=md-nav__link> 注册中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/monitor.md title=监控中心扩展 class=md-nav__link> 监控中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/extension-factory.md title=扩展点加载扩展 class=md-nav__link> 扩展点加载扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/proxy-factory.md title=动态代理扩展 class=md-nav__link> 动态代理扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/compiler.md title=编译器扩展 class=md-nav__link> 编译器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/dispatcher.md title=消息派发扩展 class=md-nav__link> 消息派发扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/threadpool.md title=线程池扩展 class=md-nav__link> 线程池扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/serialize.md title=序列化扩展 class=md-nav__link> 序列化扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/remoting.md title=网络传输扩展 class=md-nav__link> 网络传输扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exchanger.md title=信息交换扩展 class=md-nav__link> 信息交换扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/networker.md title=组网扩展 class=md-nav__link> 组网扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/telnet-handler.md title="Telnet 命令扩展" class=md-nav__link> Telnet 命令扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/status-checker.md title=状态检查扩展 class=md-nav__link> 状态检查扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/container.md title=容器扩展 class=md-nav__link> 容器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/page.md title=页面扩展 class=md-nav__link> 页面扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cache.md title=缓存扩展 class=md-nav__link> 缓存扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/validation.md title=验证扩展 class=md-nav__link> 验证扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/logger-adapter.md title=日志适配扩展 class=md-nav__link> 日志适配扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/config-center.md title=配置中心 class=md-nav__link> 配置中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contract.md title=公共契约 class=md-nav__link> 公共契约 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/coding.md title=编码约定 class=md-nav__link> 编码约定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-8 type=checkbox id=nav-1-2-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-8> 设计原则 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=设计原则 data-md-level=3> <label class=md-nav__title for=nav-1-2-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 设计原则 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/code-detail.md title=魔鬼在细节 class=md-nav__link> 魔鬼在细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/general-knowledge.md title=一些设计上的基本常识 class=md-nav__link> 一些设计上的基本常识 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/expansibility.md title=谈谈扩充式扩展与增量式扩展 class=md-nav__link> 谈谈扩充式扩展与增量式扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/configuration.md title=配置设计 class=md-nav__link> 配置设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/robustness.md title=设计实现的健壮性 class=md-nav__link> 设计实现的健壮性 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/dummy.md title=防痴呆设计 class=md-nav__link> 防痴呆设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/extension.md title=扩展点重构 class=md-nav__link> 扩展点重构 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/release.md title=版本发布 class=md-nav__link> 版本发布 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contribution.md title=贡献代码 class=md-nav__link> 贡献代码 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/checklist.md title=检查列表 class=md-nav__link> 检查列表 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/code-smell.md title=坏味道 class=md-nav__link> 坏味道 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/TCK.md title=兼容性测试 class=md-nav__link> 兼容性测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-3> 管理者文档 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=管理者文档 data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 管理者文档 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/introduction.md title="Dubbo Admin介绍" class=md-nav__link> Dubbo Admin介绍 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceSearch.md title=服务搜索和详情 class=md-nav__link> 服务搜索和详情 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceGovernance.md title=服务治理 class=md-nav__link> 服务治理 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceTest.md title=服务测试 class=md-nav__link> 服务测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 3.0 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=3.0 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 3.0 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1> 用户手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=用户手册 data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 用户手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1 type=checkbox id=nav-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1> 入门 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=入门 data-md-level=3> <label class=md-nav__title for=nav-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 入门 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/background/ title=背景 class=md-nav__link> 背景 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/background/ title=需求 class=md-nav__link> 需求 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/architecture/ title=架构 class=md-nav__link> 架构 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/usage/ title=用法 class=md-nav__link> 用法 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 博客 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=博客 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 博客 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/apache-dubbo-2019-2020/ title="2019-2020 回顾" class=md-nav__link> 2019-2020 回顾 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 开发者指南 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发者指南 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发者指南 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/developers_dev/ title=开发者指引 class=md-nav__link> 开发者指引 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 简介 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 继承体系 </a> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 源码分析 </a> <nav class=md-nav aria-label="3. 源码分析"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-staticdirectory class=md-nav__link> 3.1 StaticDirectory </a> </li> <li class=md-nav__item> <a href=#32-registrydirectory class=md-nav__link> 3.2 RegistryDirectory </a> <nav class=md-nav aria-label="3.2 RegistryDirectory"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#321-invoker class=md-nav__link> 3.2.1 列举 Invoker </a> </li> <li class=md-nav__item> <a href=#322 class=md-nav__link> 3.2.2 接收服务变更通知 </a> </li> <li class=md-nav__item> <a href=#323-invoker class=md-nav__link> 3.2.3 刷新 Invoker 列表 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4 class=md-nav__link> 4. 总结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/apache/dubbo-website/edit/master/zh-cn/docs/3.0/source_code_guide/directory.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>服务目录</h1> <h2 id=1>1. 简介<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>本篇文章，将开始分析 Dubbo 集群容错方面的源码。集群容错源码包含四个部分，分别是服务目录 Directory、服务路由 Router、集群 Cluster 和负载均衡 LoadBalance。这几个部分的源码逻辑相对比较独立，我们将会分四篇文章进行分析。本篇文章作为集群容错的开篇文章，将和大家一起分析服务目录相关的源码。在进行深入分析之前，我们先来了解一下服务目录是什么。服务目录中存储了一些和服务提供者有关的信息，通过服务目录，服务消费者可获取到服务提供者的信息，比如 ip、端口、服务协议等。通过这些信息，服务消费者就可通过 Netty 等客户端进行远程调用。在一个服务集群中，服务提供者数量并不是一成不变的，如果集群中新增了一台机器，相应地在服务目录中就要新增一条服务提供者记录。或者，如果服务提供者的配置修改了，服务目录中的记录也要做相应的更新。如果这样说，服务目录和注册中心的功能不就雷同了吗？确实如此，这里这么说是为了方便大家理解。实际上服务目录在获取注册中心的服务配置信息后，会为每条配置信息生成一个 Invoker 对象，并把这个 Invoker 对象存储起来，这个 Invoker 才是服务目录最终持有的对象。Invoker 有什么用呢？看名字就知道了，这是一个具有远程调用功能的对象。讲到这大家应该知道了什么是服务目录了，它可以看做是 Invoker 集合，且这个集合中的元素会随注册中心的变化而进行动态调整。</p> <p>关于服务目录这里就先介绍这些，大家先有个大致印象。接下来我们通过继承体系图来了解一下服务目录的家族成员都有哪些。</p> <h2 id=2>2. 继承体系<a class=headerlink href=#2 title="Permanent link">&para;</a></h2> <p>服务目录目前内置的实现有两个，分别为 StaticDirectory 和 RegistryDirectory，它们均是 AbstractDirectory 的子类。AbstractDirectory 实现了 Directory 接口，这个接口包含了一个重要的方法定义，即 list(Invocation)，用于列举 Invoker。下面我们来看一下他们的继承体系图。</p> <p><img alt src=../sources/images/directory-inherit-hierarchy.png></p> <p>如上，Directory 继承自 Node 接口，Node 这个接口继承者比较多，像 Registry、Monitor、Invoker 等均继承了这个接口。这个接口包含了一个获取配置信息的方法 getUrl，实现该接口的类可以向外提供配置信息。另外，大家注意看 RegistryDirectory 实现了 NotifyListener 接口，当注册中心节点信息发生变化后，RegistryDirectory 可以通过此接口方法得到变更信息，并根据变更信息动态调整内部 Invoker 列表。</p> <h2 id=3>3. 源码分析<a class=headerlink href=#3 title="Permanent link">&para;</a></h2> <p>本章将分析 AbstractDirectory 和它两个子类的源码。AbstractDirectory 封装了 Invoker 列举流程，具体的列举逻辑则由子类实现，这是典型的模板模式。所以，接下来我们先来看一下 AbstractDirectory 的源码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=nf>list</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>destroyed</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(</span><span class=s>&quot;Directory already destroyed...&quot;</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// 调用 doList 方法列举 Invoker，doList 是模板方法，由子类实现</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span> <span class=o>=</span> <span class=n>doList</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>

    <span class=c1>// 获取路由 Router 列表</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Router</span><span class=o>&gt;</span> <span class=n>localRouters</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>routers</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localRouters</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>localRouters</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Router</span> <span class=n>router</span> <span class=p>:</span> <span class=n>localRouters</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=c1>// 获取 runtime 参数，并根据参数决定是否进行路由</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>router</span><span class=p>.</span><span class=na>getUrl</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>router</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>RUNTIME_KEY</span><span class=p>,</span> <span class=kc>false</span><span class=p>))</span> <span class=p>{</span>
                    <span class=c1>// 进行服务路由</span>
                    <span class=n>invokers</span> <span class=o>=</span> <span class=n>router</span><span class=p>.</span><span class=na>route</span><span class=p>(</span><span class=n>invokers</span><span class=p>,</span> <span class=n>getConsumerUrl</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&quot;Failed to execute router: ...&quot;</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>invokers</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// 模板方法，由子类实现</span>
<span class=kd>protected</span> <span class=kd>abstract</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=nf>doList</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span><span class=p>;</span>
</code></pre></div> <p>上面就是 AbstractDirectory 的 list 方法源码，这个方法封装了 Invoker 的列举过程。如下：</p> <ol> <li>调用 doList 获取 Invoker 列表</li> <li>根据 Router 的 getUrl 返回值为空与否，以及 runtime 参数决定是否进行服务路由</li> </ol> <p>以上步骤中，doList 是模板方法，需由子类实现。Router 的 runtime 参数这里简单说明一下，这个参数决定了是否在每次调用服务时都执行路由规则。如果 runtime 为 true，那么每次调用服务前，都需要进行服务路由。这个对性能造成影响，配置时需要注意。</p> <p>关于 AbstractDirectory 就分析这么多，下面开始分析子类的源码。</p> <h3 id=31-staticdirectory>3.1 StaticDirectory<a class=headerlink href=#31-staticdirectory title="Permanent link">&para;</a></h3> <p>StaticDirectory 即静态服务目录，顾名思义，它内部存放的 Invoker 是不会变动的。所以，理论上它和不可变 List 的功能很相似。下面我们来看一下这个类的实现。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>StaticDirectory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>AbstractDirectory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=c1>// Invoker 列表</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>;</span>

    <span class=c1>// 省略构造方法</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>getInterface</span><span class=p>()</span> <span class=p>{</span>
        <span class=c1>// 获取接口类</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getInterface</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// 检测服务目录是否可用</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isAvailable</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isDestroyed</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>invoker</span><span class=p>.</span><span class=na>isAvailable</span><span class=p>())</span> <span class=p>{</span>
                <span class=c1>// 只要有一个 Invoker 是可用的，就认为当前目录是可用的</span>
                <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>destroy</span><span class=p>()</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>isDestroyed</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 调用父类销毁逻辑</span>
        <span class=kd>super</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span>
        <span class=c1>// 遍历 Invoker 列表，并执行相应的销毁逻辑</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>invoker</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=n>invokers</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=nf>doList</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>RpcException</span> <span class=p>{</span>
        <span class=c1>// 列举 Inovker，也就是直接返回 invokers 成员变量</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>以上就是 StaticDirectory 的代码逻辑，很简单，就不多说了。下面来看看 RegistryDirectory，这个类的逻辑比较复杂。</p> <h3 id=32-registrydirectory>3.2 RegistryDirectory<a class=headerlink href=#32-registrydirectory title="Permanent link">&para;</a></h3> <p>RegistryDirectory 是一种动态服务目录，实现了 NotifyListener 接口。当注册中心服务配置发生变化后，RegistryDirectory 可收到与当前服务相关的变化。收到变更通知后，RegistryDirectory 可根据配置变更信息刷新 Invoker 列表。RegistryDirectory 中有几个比较重要的逻辑，第一是 Invoker 的列举逻辑，第二是接收服务配置变更的逻辑，第三是 Invoker 列表的刷新逻辑。接下来按顺序对这三块逻辑。</p> <h4 id=321-invoker>3.2.1 列举 Invoker<a class=headerlink href=#321-invoker title="Permanent link">&para;</a></h4> <p>Invoker 列举逻辑封装在 doList 方法中，相关代码如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=nf>doList</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>forbidden</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 服务提供者关闭或禁用了服务，此时抛出 No provider 异常</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>RpcException</span><span class=p>(</span><span class=n>RpcException</span><span class=p>.</span><span class=na>FORBIDDEN_EXCEPTION</span><span class=p>,</span>
            <span class=s>&quot;No provider available from registry ...&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=c1>// 获取 Invoker 本地缓存</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>localMethodInvokerMap</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>methodInvokerMap</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localMethodInvokerMap</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>localMethodInvokerMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 获取方法名和参数列表</span>
        <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=n>Object</span><span class=o>[]</span> <span class=n>args</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>getArguments</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=c1>// 检测参数列表的第一个参数是否为 String 或 enum 类型</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>args</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>args</span><span class=p>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>!=</span> <span class=kc>null</span>
                <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=k>instanceof</span> <span class=n>String</span> <span class=o>||</span> <span class=n>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>isEnum</span><span class=p>()))</span> <span class=p>{</span>
            <span class=c1>// 通过 方法名 + 第一个参数名称 查询 Invoker 列表，具体的使用场景暂时没想到</span>
            <span class=n>invokers</span> <span class=o>=</span> <span class=n>localMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>methodName</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>args</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invokers</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 通过方法名获取 Invoker 列表</span>
            <span class=n>invokers</span> <span class=o>=</span> <span class=n>localMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>methodName</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invokers</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 通过星号 * 获取 Invoker 列表</span>
            <span class=n>invokers</span> <span class=o>=</span> <span class=n>localMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>ANY_VALUE</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 冗余逻辑，pull request #2861 移除了下面的 if 分支代码</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invokers</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>localMethodInvokerMap</span><span class=p>.</span><span class=na>values</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>invokers</span> <span class=o>=</span> <span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 返回 Invoker 列表</span>
    <span class=k>return</span> <span class=n>invokers</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>以上代码进行多次尝试，以期从 localMethodInvokerMap 中获取到 Invoker 列表。一般情况下，普通的调用可通过方法名获取到对应的 Invoker 列表，泛化调用可通过 ***** 获取到 Invoker 列表。localMethodInvokerMap 源自 RegistryDirectory 类的成员变量 methodInvokerMap。doList 方法可以看做是对 methodInvokerMap 变量的读操作，至于对 methodInvokerMap 变量的写操作，下一节进行分析。</p> <h4 id=322>3.2.2 接收服务变更通知<a class=headerlink href=#322 title="Permanent link">&para;</a></h4> <p>RegistryDirectory 是一个动态服务目录，会随注册中心配置的变化进行动态调整。因此 RegistryDirectory 实现了 NotifyListener 接口，通过这个接口获取注册中心变更通知。下面我们来看一下具体的逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>notify</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>urls</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 定义三个集合，分别用于存放服务提供者 url，路由 url，配置器 url</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>invokerUrls</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=p>();</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>routerUrls</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=p>();</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>configuratorUrls</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=p>();</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>URL</span> <span class=n>url</span> <span class=p>:</span> <span class=n>urls</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>protocol</span> <span class=o>=</span> <span class=n>url</span><span class=p>.</span><span class=na>getProtocol</span><span class=p>();</span>
        <span class=c1>// 获取 category 参数</span>
        <span class=n>String</span> <span class=n>category</span> <span class=o>=</span> <span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>CATEGORY_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_CATEGORY</span><span class=p>);</span>
        <span class=c1>// 根据 category 参数将 url 分别放到不同的列表中</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>ROUTERS_CATEGORY</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>category</span><span class=p>)</span>
                <span class=o>||</span> <span class=n>Constants</span><span class=p>.</span><span class=na>ROUTE_PROTOCOL</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>protocol</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 添加路由器 url</span>
            <span class=n>routerUrls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>CONFIGURATORS_CATEGORY</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>category</span><span class=p>)</span>
                <span class=o>||</span> <span class=n>Constants</span><span class=p>.</span><span class=na>OVERRIDE_PROTOCOL</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>protocol</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 添加配置器 url</span>
            <span class=n>configuratorUrls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>PROVIDERS_CATEGORY</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>category</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 添加服务提供者 url</span>
            <span class=n>invokerUrls</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 忽略不支持的 category</span>
            <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;Unsupported category ...&quot;</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>configuratorUrls</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>configuratorUrls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// 将 url 转成 Configurator</span>
        <span class=k>this</span><span class=p>.</span><span class=na>configurators</span> <span class=o>=</span> <span class=n>toConfigurators</span><span class=p>(</span><span class=n>configuratorUrls</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>routerUrls</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>routerUrls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=c1>// 将 url 转成 Router</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Router</span><span class=o>&gt;</span> <span class=n>routers</span> <span class=o>=</span> <span class=n>toRouters</span><span class=p>(</span><span class=n>routerUrls</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>routers</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>setRouters</span><span class=p>(</span><span class=n>routers</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Configurator</span><span class=o>&gt;</span> <span class=n>localConfigurators</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>configurators</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>overrideDirectoryUrl</span> <span class=o>=</span> <span class=n>directoryUrl</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localConfigurators</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>localConfigurators</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Configurator</span> <span class=n>configurator</span> <span class=p>:</span> <span class=n>localConfigurators</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 配置 overrideDirectoryUrl</span>
            <span class=k>this</span><span class=p>.</span><span class=na>overrideDirectoryUrl</span> <span class=o>=</span> <span class=n>configurator</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>overrideDirectoryUrl</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 刷新 Invoker 列表</span>
    <span class=n>refreshInvoker</span><span class=p>(</span><span class=n>invokerUrls</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>如上，notify 方法首先是根据 url 的 category 参数对 url 进行分门别类存储，然后通过 toRouters 和 toConfigurators 将 url 列表转成 Router 和 Configurator 列表。最后调用 refreshInvoker 方法刷新 Invoker 列表。这里的 toRouters 和 toConfigurators 方法逻辑不复杂，大家自行分析。接下来，我们把重点放在 refreshInvoker 方法上。</p> <h4 id=323-invoker>3.2.3 刷新 Invoker 列表<a class=headerlink href=#323-invoker title="Permanent link">&para;</a></h4> <p>refreshInvoker 方法是保证 RegistryDirectory 随注册中心变化而变化的关键所在。这一块逻辑比较多，接下来一一进行分析。</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>refreshInvoker</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>invokerUrls</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// invokerUrls 仅有一个元素，且 url 协议头为 empty，此时表示禁用所有服务</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>invokerUrls</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>invokerUrls</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=n>invokerUrls</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>null</span>
            <span class=o>&amp;&amp;</span> <span class=n>Constants</span><span class=p>.</span><span class=na>EMPTY_PROTOCOL</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>invokerUrls</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getProtocol</span><span class=p>()))</span> <span class=p>{</span>
        <span class=c1>// 设置 forbidden 为 true</span>
        <span class=k>this</span><span class=p>.</span><span class=na>forbidden</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=na>methodInvokerMap</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=c1>// 销毁所有 Invoker</span>
        <span class=n>destroyAllInvokers</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>forbidden</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>oldUrlInvokerMap</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>urlInvokerMap</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invokerUrls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=na>cachedInvokerUrls</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 添加缓存 url 到 invokerUrls 中</span>
            <span class=n>invokerUrls</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>cachedInvokerUrls</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=na>cachedInvokerUrls</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span><span class=p>();</span>
            <span class=c1>// 缓存 invokerUrls</span>
            <span class=k>this</span><span class=p>.</span><span class=na>cachedInvokerUrls</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>invokerUrls</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invokerUrls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 将 url 转成 Invoker</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>newUrlInvokerMap</span> <span class=o>=</span> <span class=n>toInvokers</span><span class=p>(</span><span class=n>invokerUrls</span><span class=p>);</span>
        <span class=c1>// 将 newUrlInvokerMap 转成方法名到 Invoker 列表的映射</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>newMethodInvokerMap</span> <span class=o>=</span> <span class=n>toMethodInvokers</span><span class=p>(</span><span class=n>newUrlInvokerMap</span><span class=p>);</span>
        <span class=c1>// 转换出错，直接打印异常，并返回</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>newUrlInvokerMap</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>newUrlInvokerMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;urls to invokers error ...&quot;</span><span class=p>));</span>
            <span class=k>return</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 合并多个组的 Invoker</span>
        <span class=k>this</span><span class=p>.</span><span class=na>methodInvokerMap</span> <span class=o>=</span> <span class=n>multiGroup</span> <span class=o>?</span> <span class=n>toMergeMethodInvokerMap</span><span class=p>(</span><span class=n>newMethodInvokerMap</span><span class=p>)</span> <span class=p>:</span> <span class=n>newMethodInvokerMap</span><span class=p>;</span>
        <span class=k>this</span><span class=p>.</span><span class=na>urlInvokerMap</span> <span class=o>=</span> <span class=n>newUrlInvokerMap</span><span class=p>;</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=c1>// 销毁无用 Invoker</span>
            <span class=n>destroyUnusedInvokers</span><span class=p>(</span><span class=n>oldUrlInvokerMap</span><span class=p>,</span> <span class=n>newUrlInvokerMap</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;destroyUnusedInvokers error. &quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>refreshInvoker 方法首先会根据入参 invokerUrls 的数量和协议头判断是否禁用所有的服务，如果禁用，则将 forbidden 设为 true，并销毁所有的 Invoker。若不禁用，则将 url 转成 Invoker，得到 \&lt;url, Invoker> 的映射关系。然后进一步进行转换，得到 \&lt;methodName, Invoker 列表> 映射关系。之后进行多组 Invoker 合并操作，并将合并结果赋值给 methodInvokerMap。methodInvokerMap 变量在 doList 方法中会被用到，doList 会对该变量进行读操作，在这里是写操作。当新的 Invoker 列表生成后，还要一个重要的工作要做，就是销毁无用的 Invoker，避免服务消费者调用已下线的服务的服务。</p> <p>接下来对 refreshInvoker 方法中涉及到的调用一一进行分析。按照顺序，先来分析 url 到 Invoker 的转换过程。</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=nf>toInvokers</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>URL</span><span class=o>&gt;</span> <span class=n>urls</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>newUrlInvokerMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>urls</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>urls</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>newUrlInvokerMap</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>Set</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>keys</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>();</span>
    <span class=c1>// 获取服务消费端配置的协议</span>
    <span class=n>String</span> <span class=n>queryProtocols</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>queryMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>PROTOCOL_KEY</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>URL</span> <span class=n>providerUrl</span> <span class=p>:</span> <span class=n>urls</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>queryProtocols</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>queryProtocols</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>boolean</span> <span class=n>accept</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=n>String</span><span class=o>[]</span> <span class=n>acceptProtocols</span> <span class=o>=</span> <span class=n>queryProtocols</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&quot;,&quot;</span><span class=p>);</span>
            <span class=c1>// 检测服务提供者协议是否被服务消费者所支持</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>acceptProtocol</span> <span class=p>:</span> <span class=n>acceptProtocols</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>providerUrl</span><span class=p>.</span><span class=na>getProtocol</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>acceptProtocol</span><span class=p>))</span> <span class=p>{</span>
                    <span class=n>accept</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
                    <span class=k>break</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>accept</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 若服务消费者协议头不被消费者所支持，则忽略当前 providerUrl</span>
                <span class=k>continue</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// 忽略 empty 协议</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>EMPTY_PROTOCOL</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>providerUrl</span><span class=p>.</span><span class=na>getProtocol</span><span class=p>()))</span> <span class=p>{</span>
            <span class=k>continue</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=c1>// 通过 SPI 检测服务端协议是否被消费端支持，不支持则抛出异常</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ExtensionLoader</span><span class=p>.</span><span class=na>getExtensionLoader</span><span class=p>(</span><span class=n>Protocol</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>hasExtension</span><span class=p>(</span><span class=n>providerUrl</span><span class=p>.</span><span class=na>getProtocol</span><span class=p>()))</span> <span class=p>{</span>
            <span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unsupported protocol...&quot;</span><span class=p>));</span>
            <span class=k>continue</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 合并 url</span>
        <span class=n>URL</span> <span class=n>url</span> <span class=o>=</span> <span class=n>mergeUrl</span><span class=p>(</span><span class=n>providerUrl</span><span class=p>);</span>

        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>url</span><span class=p>.</span><span class=na>toFullString</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>keys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=p>{</span>
            <span class=c1>// 忽略重复 url</span>
            <span class=k>continue</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=n>keys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=c1>// 将本地 Invoker 缓存赋值给 localUrlInvokerMap</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>localUrlInvokerMap</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=na>urlInvokerMap</span><span class=p>;</span>
        <span class=c1>// 获取与 url 对应的 Invoker</span>
        <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=o>=</span> <span class=n>localUrlInvokerMap</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=kc>null</span> <span class=p>:</span> <span class=n>localUrlInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=c1>// 缓存未命中</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>invoker</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>try</span> <span class=p>{</span>
                <span class=kt>boolean</span> <span class=n>enabled</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>hasParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>DISABLED_KEY</span><span class=p>))</span> <span class=p>{</span>
                    <span class=c1>// 获取 disable 配置，取反，然后赋值给 enable 变量</span>
                    <span class=n>enabled</span> <span class=o>=</span> <span class=o>!</span><span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>DISABLED_KEY</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
                    <span class=c1>// 获取 enable 配置，并赋值给 enable 变量</span>
                    <span class=n>enabled</span> <span class=o>=</span> <span class=n>url</span><span class=p>.</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>ENABLED_KEY</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
                <span class=p>}</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>enabled</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// 调用 refer 获取 Invoker</span>
                    <span class=n>invoker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InvokerDelegate</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>protocol</span><span class=p>.</span><span class=na>refer</span><span class=p>(</span><span class=n>serviceType</span><span class=p>,</span> <span class=n>url</span><span class=p>),</span> <span class=n>url</span><span class=p>,</span> <span class=n>providerUrl</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>logger</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&quot;Failed to refer invoker for interface...&quot;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>invoker</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 缓存 Invoker 实例</span>
                <span class=n>newUrlInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>invoker</span><span class=p>);</span>
            <span class=p>}</span>

        <span class=c1>// 缓存命中</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=c1>// 将 invoker 存储到 newUrlInvokerMap 中</span>
            <span class=n>newUrlInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>invoker</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>keys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>newUrlInvokerMap</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>toInvokers 方法一开始会对服务提供者 url 进行检测，若服务消费端的配置不支持服务端的协议，或服务端 url 协议头为 empty 时，toInvokers 均会忽略服务提供方 url。必要的检测做完后，紧接着是合并 url，然后访问缓存，尝试获取与 url 对应的 invoker。如果缓存命中，直接将 Invoker 存入 newUrlInvokerMap 中即可。如果未命中，则需新建 Invoker。</p> <p>toInvokers 方法返回的是 \&lt;url, Invoker> 映射关系表，接下来还要对这个结果进行进一步处理，得到方法名到 Invoker 列表的映射关系。这个过程由 toMethodInvokers 方法完成，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=nf>toMethodInvokers</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokersMap</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 方法名 -&gt; Invoker 列表</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>newMethodInvokerMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span><span class=p>();</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokersList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>invokersMap</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>invokersMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokersMap</span><span class=p>.</span><span class=na>values</span><span class=p>())</span> <span class=p>{</span>
            <span class=c1>// 获取 methods 参数</span>
            <span class=n>String</span> <span class=n>parameter</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>METHODS_KEY</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>parameter</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>parameter</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 切分 methods 参数值，得到方法名数组</span>
                <span class=n>String</span><span class=o>[]</span> <span class=n>methods</span> <span class=o>=</span> <span class=n>Constants</span><span class=p>.</span><span class=na>COMMA_SPLIT_PATTERN</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>parameter</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>methods</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>methods</span><span class=p>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>method</span> <span class=p>:</span> <span class=n>methods</span><span class=p>)</span> <span class=p>{</span>
                        <span class=c1>// 方法名不为 *</span>
                        <span class=k>if</span> <span class=p>(</span><span class=n>method</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>method</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span>
                                <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>Constants</span><span class=p>.</span><span class=na>ANY_VALUE</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>method</span><span class=p>))</span> <span class=p>{</span>
                            <span class=c1>// 根据方法名获取 Invoker 列表</span>
                            <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>methodInvokers</span> <span class=o>=</span> <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
                            <span class=k>if</span> <span class=p>(</span><span class=n>methodInvokers</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                                <span class=n>methodInvokers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
                                <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>methodInvokers</span><span class=p>);</span>
                            <span class=p>}</span>
                            <span class=c1>// 存储 Invoker 到列表中</span>
                            <span class=n>methodInvokers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invoker</span><span class=p>);</span>
                        <span class=p>}</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=n>invokersList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invoker</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 进行服务级别路由，参考 pull request #749</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>newInvokersList</span> <span class=o>=</span> <span class=n>route</span><span class=p>(</span><span class=n>invokersList</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
    <span class=c1>// 存储 &lt;*, newInvokersList&gt; 映射关系</span>
    <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>ANY_VALUE</span><span class=p>,</span> <span class=n>newInvokersList</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>serviceMethods</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>serviceMethods</span><span class=p>.</span><span class=na>length</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>method</span> <span class=p>:</span> <span class=n>serviceMethods</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>methodInvokers</span> <span class=o>=</span> <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>methodInvokers</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>methodInvokers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>methodInvokers</span> <span class=o>=</span> <span class=n>newInvokersList</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=c1>// 进行方法级别路由</span>
            <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>route</span><span class=p>(</span><span class=n>methodInvokers</span><span class=p>,</span> <span class=n>method</span><span class=p>));</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=c1>// 排序，转成不可变列表</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>method</span> <span class=p>:</span> <span class=k>new</span> <span class=n>HashSet</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>(</span><span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>keySet</span><span class=p>()))</span> <span class=p>{</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>methodInvokers</span> <span class=o>=</span> <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>method</span><span class=p>);</span>
        <span class=n>Collections</span><span class=p>.</span><span class=na>sort</span><span class=p>(</span><span class=n>methodInvokers</span><span class=p>,</span> <span class=n>InvokerComparator</span><span class=p>.</span><span class=na>getComparator</span><span class=p>());</span>
        <span class=n>newMethodInvokerMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>methodInvokers</span><span class=p>));</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableMap</span><span class=p>(</span><span class=n>newMethodInvokerMap</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>上面方法主要做了三件事情， 第一是对入参进行遍历，然后从 Invoker 的 url 成员变量中获取 methods 参数，并切分成数组。随后以方法名为键，Invoker 列表为值，将映射关系存储到 newMethodInvokerMap 中。第二是分别基于类和方法对 Invoker 列表进行路由操作。第三是对 Invoker 列表进行排序，并转成不可变列表。关于 toMethodInvokers 方法就先分析到这，我们继续向下分析，这次要分析的多组服务的合并逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=nf>toMergeMethodInvokerMap</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>methodMap</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span><span class=p>();</span>
    <span class=c1>// 遍历入参</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>methodMap</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>method</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
        <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span> <span class=o>=</span> <span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
        <span class=c1>// group -&gt; Invoker 列表</span>
        <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span> <span class=n>groupMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;&gt;</span><span class=p>();</span>
        <span class=c1>// 遍历 Invoker 列表</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 获取分组配置</span>
            <span class=n>String</span> <span class=n>group</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>GROUP_KEY</span><span class=p>,</span> <span class=s>&quot;&quot;</span><span class=p>);</span>
            <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>groupInvokers</span> <span class=o>=</span> <span class=n>groupMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>group</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>groupInvokers</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>groupInvokers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
                <span class=c1>// 缓存 &lt;group, List&lt;Invoker&gt;&gt; 到 groupMap 中</span>
                <span class=n>groupMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>group</span><span class=p>,</span> <span class=n>groupInvokers</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=c1>// 存储 invoker 到 groupInvokers</span>
            <span class=n>groupInvokers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invoker</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>groupMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 如果 groupMap 中仅包含一组键值对，此时直接取出该键值对的值即可</span>
            <span class=n>result</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>groupMap</span><span class=p>.</span><span class=na>values</span><span class=p>().</span><span class=na>iterator</span><span class=p>().</span><span class=na>next</span><span class=p>());</span>

        <span class=c1>// groupMap.size() &gt; 1 成立，表示 groupMap 中包含多组键值对，比如：</span>
        <span class=c1>// {</span>
        <span class=c1>//     &quot;dubbo&quot;: [invoker1, invoker2, invoker3, ...],</span>
        <span class=c1>//     &quot;hello&quot;: [invoker4, invoker5, invoker6, ...]</span>
        <span class=c1>// }</span>
        <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>groupMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>groupInvokers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>groupList</span> <span class=p>:</span> <span class=n>groupMap</span><span class=p>.</span><span class=na>values</span><span class=p>())</span> <span class=p>{</span>
                <span class=c1>// 通过集群类合并每个分组对应的 Invoker 列表</span>
                <span class=n>groupInvokers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>cluster</span><span class=p>.</span><span class=na>join</span><span class=p>(</span><span class=k>new</span> <span class=n>StaticDirectory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>groupList</span><span class=p>)));</span>
            <span class=p>}</span>
            <span class=c1>// 缓存结果</span>
            <span class=n>result</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>groupInvokers</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
            <span class=n>result</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>method</span><span class=p>,</span> <span class=n>invokers</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>上面方法首先是生成 group 到 Invoker 列表的映射关系表，若关系表中的映射关系数量大于1，表示有多组服务。此时通过集群类合并每组 Invoker，并将合并结果存储到 groupInvokers 中。之后将方法名与 groupInvokers 存到到 result 中，并返回，整个逻辑结束。</p> <p>接下来我们再来看一下 Invoker 列表刷新逻辑的最后一个动作 — 删除无用 Invoker。如下：</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>destroyUnusedInvokers</span><span class=p>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>oldUrlInvokerMap</span><span class=p>,</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>newUrlInvokerMap</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>newUrlInvokerMap</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>newUrlInvokerMap</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>destroyAllInvokers</span><span class=p>();</span>
        <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>deleted</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>oldUrlInvokerMap</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 获取新生成的 Invoker 列表</span>
        <span class=n>Collection</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>newInvokers</span> <span class=o>=</span> <span class=n>newUrlInvokerMap</span><span class=p>.</span><span class=na>values</span><span class=p>();</span>
        <span class=c1>// 遍历老的 &lt;url, Invoker&gt; 映射表</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>oldUrlInvokerMap</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
            <span class=c1>// 检测 newInvokers 中是否包含老的 Invoker</span>
            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>newInvokers</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>()))</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>deleted</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>deleted</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>();</span>
                <span class=p>}</span>
                <span class=c1>// 若不包含，则将老的 Invoker 对应的 url 存入 deleted 列表中</span>
                <span class=n>deleted</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>getKey</span><span class=p>());</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>deleted</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 遍历 deleted 集合，并到老的 &lt;url, Invoker&gt; 映射关系表查出 Invoker，销毁之</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>url</span> <span class=p>:</span> <span class=n>deleted</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>url</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 从 oldUrlInvokerMap 中移除 url 对应的 Invoker</span>
                <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=o>=</span> <span class=n>oldUrlInvokerMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>invoker</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>try</span> <span class=p>{</span>
                        <span class=c1>// 销毁 Invoker</span>
                        <span class=n>invoker</span><span class=p>.</span><span class=na>destroy</span><span class=p>();</span>
                    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>logger</span><span class=p>.</span><span class=na>warn</span><span class=p>(</span><span class=s>&quot;destroy invoker...&quot;</span><span class=p>);</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>destroyUnusedInvokers 方法的主要逻辑是通过 newUrlInvokerMap 找出待删除 Invoker 对应的 url，并将 url 存入到 deleted 列表中。然后再遍历 deleted 列表，并从 oldUrlInvokerMap 中移除相应的 Invoker，销毁之。整个逻辑大致如此，不是很难理解。</p> <p>到此关于 Invoker 列表的刷新逻辑就分析了，这里对整个过程进行简单总结。如下：</p> <ol> <li>检测入参是否仅包含一个 url，且 url 协议头为 empty</li> <li>若第一步检测结果为 true，表示禁用所有服务，此时销毁所有的 Invoker</li> <li>若第一步检测结果为 false，此时将入参转为 Invoker 列表</li> <li>对上一步逻辑生成的结果进行进一步处理，得到方法名到 Invoker 的映射关系表</li> <li>合并多组 Invoker</li> <li>销毁无用 Invoker</li> </ol> <p>Invoker 的刷新逻辑还是比较复杂的，大家在看的过程中多写点 demo 进行调试，以加深理解。</p> <h2 id=4>4. 总结<a class=headerlink href=#4 title="Permanent link">&para;</a></h2> <p>本篇文章对 Dubbo 服务目录进行了较为详细的分析，篇幅主要集中在 RegistryDirectory 的源码分析上。从代码量上可以看出，想让本地服务目录和注册中心保持一致还是需要做很多事情的，并不简单。服务目录是 Dubbo 集群容错的一部分，也是比较基础的部分，所以大家应尽量搞懂。</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/squidfunk target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://gitter.im/squidfunk/mkdocs-material target=_blank rel=noopener title=gitter.im class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg> </a> <a href=https://hub.docker.com/r/squidfunk/mkdocs-material/ target=_blank rel=noopener title=hub.docker.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://twitter.com/squidfunk target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/squidfunk/ target=_blank rel=noopener title=linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://instagram.com/squidfunk target=_blank rel=noopener title=instagram.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/vendor.77e55a48.min.js></script> <script src=../../../../assets/javascripts/bundle.9554a270.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../../..",
          features: ['tabs', 'search.highlight'],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>