<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=本文介绍了集群的原理和实现细节><link rel="shortcut icon" href=../../../../assets/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.5.6"><title>负载均衡 - Apache Dubbo</title><link rel=stylesheet href=../../../../assets/stylesheets/main.63b94e9e.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.7f672a1f.min.css><meta name=theme-color content=#3f51b5><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../../../../css/dropdown.css></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Application header --> <header class=md-header data-md-component=header> <!-- Top-level navigation --> <nav class="md-header-nav md-grid" aria-label=Header> <!-- Link to home --> <a href=../../../.. title="Apache Dubbo" class="md-header-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"><path d="M3.136 17.387v42.932l42.932 21.467L3.136 17.387z"/><path fill-opacity=.5 d="M21.91 8l42.933 64.398-18.775 9.388L3.136 17.387 21.91 8z"/><path d="M67.535 17.387L40.273 35.543l21.878 32.818 5.384 2.691V17.387z"/><path fill-opacity=.25 d="M67.535 17.387v53.666l18.774-9.388V8l-18.774 9.387z"/></svg> </a> <!-- Button to open drawer --> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <!-- Header title --> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Apache Dubbo </span> <span class="md-header-nav__topic md-ellipsis"> 负载均衡 </span> </div> </div> <!-- Button to open search dialogue --> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <!-- Search interface --> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div> <div class=langChange id=translate title=中文|English> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"> <path d="M12.87 15.07l-2.54-2.51.03-.03A17.52 17.52 0 0014.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7l1.62-4.33L19.12 17h-3.24z"/> </svg> </div> <script>
    var translate = document.getElementById('translate');
    translate.addEventListener('click', changeHref, false);
    function changeHref() {
        if (window.location.href.search('en-us') !== -1) {
            var changeHref = window.location.href.replace('en-us', 'zh-cn');

        } else {
            var changeHref = window.location.href.replace('zh-cn', 'en-us');
        }
        window.location.href = changeHref
    }
</script> <style>
    .langChange {
        display: inline-block;
        width: 2.4rem;
        height: 2.4rem;
        vertical-align: middle;
        margin-left: .5rem;
    }

    .langChange svg {
        fill: rgba(255, 255, 255, 0.548);
        display: block;
        width: 1.2rem;
        height: 1.2rem;
        margin: 0 auto;
        margin-top: .6rem;
        margin-left: .6rem;
    }

    .langChange :hover {
        fill: white;
        cursor: pointer;
    }
</style> </div> <!-- Repository containing source --> <div class=md-header-nav__source> <a href=https://github.com/apache/dubbo-website/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <li class=md-tabs__item> <a href=../../../.. class="md-tabs__link md-tabs__link--active"> 首页 </a> </li> <!-- Main navigation item with nested items --> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../2.7/user/preface/background/ class=md-tabs__link> 文档 </a> </li> <!-- Render item --> <!-- Render item --> <!-- Render item --> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../../blog/apache-dubbo-2019-2020/ class=md-tabs__link> 博客 </a> </li> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Home page --> <!-- Recurse, if the first item has nested items --> <li class=md-tabs__item> <a href=../../../../developers/developers_dev/ class=md-tabs__link> 开发者指南 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <!--
  Copyright (c) 2016-2020 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
--> <!-- Main navigation --> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <!-- Site title --> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Apache Dubbo" class="md-nav__button md-logo" aria-label="Apache Dubbo"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 89 89"><path d="M3.136 17.387v42.932l42.932 21.467L3.136 17.387z"/><path fill-opacity=.5 d="M21.91 8l42.933 64.398-18.775 9.388L3.136 17.387 21.91 8z"/><path d="M67.535 17.387L40.273 35.543l21.878 32.818 5.384 2.691V17.387z"/><path fill-opacity=.25 d="M67.535 17.387v53.666l18.774-9.388V8l-18.774 9.387z"/></svg> </a> Apache Dubbo </label> <!-- Repository containing source --> <div class=md-nav__source> <a href=https://github.com/apache/dubbo-website/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <!-- Render item list --> <ul class=md-nav__list data-md-scrollfix> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../.. title=首页 class=md-nav__link> 首页 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 文档 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=文档 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 文档 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1> 2.7 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=2.7 data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 2.7 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1 type=checkbox id=nav-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1> 用户手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=用户手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 用户手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-1 type=checkbox id=nav-1-1-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-1> 入门 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=入门 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 入门 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/background/ title=背景 class=md-nav__link> 背景 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/requirements/ title=需求 class=md-nav__link> 需求 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/architecture/ title=架构 class=md-nav__link> 架构 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/preface/usage/ title=用法 class=md-nav__link> 用法 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/quick-start/ title=快速启动 class=md-nav__link> 快速启动 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/dependencies/ title=依赖 class=md-nav__link> 依赖 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/maturity/ title=成熟度 class=md-nav__link> 成熟度 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-5 type=checkbox id=nav-1-1-1-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-5> 配置 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=配置 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 配置 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/xml/ title="XML 配置" class=md-nav__link> XML 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/api/ title="API 配置" class=md-nav__link> API 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/annotation/ title="Annotation 配置" class=md-nav__link> Annotation 配置 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/annotation/ title=动态配置中心 class=md-nav__link> 动态配置中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/configuration-load-process/ title=配置加载流程 class=md-nav__link> 配置加载流程 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/configuration/environment-variables/ title=自动加载环境变量 class=md-nav__link> 自动加载环境变量 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-6 type=checkbox id=nav-1-1-1-6> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-6> 示例 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=示例 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-6> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 示例 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/preflight-check/ title=启动时检查 class=md-nav__link> 启动时检查 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/fault-tolerent-strategy/ title=集群容错 class=md-nav__link> 集群容错 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/loadbalance/ title=负载均衡 class=md-nav__link> 负载均衡 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/thread-model/ title=线程模型 class=md-nav__link> 线程模型 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/explicit-target/ title=直连提供者 class=md-nav__link> 直连提供者 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/subscribe-only/ title=只订阅 class=md-nav__link> 只订阅 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/registry-only/ title=只注册 class=md-nav__link> 只注册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/static-service/ title=静态服务 class=md-nav__link> 静态服务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-protocols/ title=多协议 class=md-nav__link> 多协议 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-registry/ title=多注册中心 class=md-nav__link> 多注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-group/ title=服务分组 class=md-nav__link> 服务分组 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/multi-versions/ title=多版本 class=md-nav__link> 多版本 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/group-merger/ title=分组聚合 class=md-nav__link> 分组聚合 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/parameter-validation/ title=参数验证 class=md-nav__link> 参数验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/result-cache/ title=结果缓存 class=md-nav__link> 结果缓存 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/generic-reference/ title=泛化引用 class=md-nav__link> 泛化引用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/generic-service/ title=泛化实现 class=md-nav__link> 泛化实现 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/echo-service/ title=回声测试 class=md-nav__link> 回声测试 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/context/ title=上下文信息 class=md-nav__link> 上下文信息 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/attachment/ title=隐式参数 class=md-nav__link> 隐式参数 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/async-call/ title=异步调用 class=md-nav__link> 异步调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/async-execute-on-provider/ title=服务端异步 class=md-nav__link> 服务端异步 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-call/ title=本地调用 class=md-nav__link> 本地调用 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/callback-parameter/ title=参数回调 class=md-nav__link> 参数回调 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/events-notify/ title=事件通知 class=md-nav__link> 事件通知 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-stub/ title=本地存根 class=md-nav__link> 本地存根 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/local-mock/ title=本地伪装 class=md-nav__link> 本地伪装 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/delay-publish/ title=延迟暴露 class=md-nav__link> 延迟暴露 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/concurrency-control/ title=并发控制 class=md-nav__link> 并发控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/config-connection.md title=连接控制 class=md-nav__link> 连接控制 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/lazy-connect/ title=延迟连接 class=md-nav__link> 延迟连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/stickiness/ title=粘滞连接 class=md-nav__link> 粘滞连接 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/token-authorization/ title=令牌验证 class=md-nav__link> 令牌验证 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/routing-rule/ title=路由规则 class=md-nav__link> 路由规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/config-rule/ title=配置规则 class=md-nav__link> 配置规则 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-downgrade/ title=服务降级 class=md-nav__link> 服务降级 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/graceful-shutdown/ title=优雅停机 class=md-nav__link> 优雅停机 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/hostname-binding/ title=主机绑定 class=md-nav__link> 主机绑定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/logger-strategy/ title=日志适配 class=md-nav__link> 日志适配 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/accesslog/ title=访问日志 class=md-nav__link> 访问日志 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/service-container/ title=服务容器 class=md-nav__link> 服务容器 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/distributed-transaction/ title=分布式事务 class=md-nav__link> 分布式事务 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/dump/ title=线程栈自动dump class=md-nav__link> 线程栈自动dump </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/netty4/ title=Netty4 class=md-nav__link> Netty4 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/serialization/ title=Kryo和FST序列化 class=md-nav__link> Kryo和FST序列化 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/simplify-registry-data/ title=简化注册中心URL class=md-nav__link> 简化注册中心URL </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/demos/api.md title="API 参考手册" class=md-nav__link> API 参考手册 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-7 type=checkbox id=nav-1-1-1-7> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-7> schema 配置参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="schema 配置参考手册" data-md-level=4> <label class=md-nav__title for=nav-1-1-1-7> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> schema 配置参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-service/ title=dubbo:service class=md-nav__link> dubbo:service </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-reference/ title=dubbo:reference class=md-nav__link> dubbo:reference </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-protocol/ title=dubbo:protocol class=md-nav__link> dubbo:protocol </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-registry/ title=dubbo:registry class=md-nav__link> dubbo:registry </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-monitor/ title=dubbo:monitor class=md-nav__link> dubbo:monitor </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-application/ title=dubbo:application class=md-nav__link> dubbo:application </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-module/ title=dubbo:module class=md-nav__link> dubbo:module </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-provider/ title=dubbo:provider class=md-nav__link> dubbo:provider </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-consumer/ title=dubbo:consumer class=md-nav__link> dubbo:consumer </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-method/ title=dubbo:method class=md-nav__link> dubbo:method </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-argument/ title=dubbo:argument class=md-nav__link> dubbo:argument </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-parameter/ title=dubbo:parameter class=md-nav__link> dubbo:parameter </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/xml/dubbo-config-center/ title=dubbo:config-center class=md-nav__link> dubbo:config-center </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-8 type=checkbox id=nav-1-1-1-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-8> 协议参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=协议参考手册 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 协议参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/dubbo/ title=dubbo:// class=md-nav__link> dubbo:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/rmi/ title=rmi:// class=md-nav__link> rmi:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/hessian/ title=hessian:// class=md-nav__link> hessian:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/http/ title=http:// class=md-nav__link> http:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/thrift/ title=thrift:// class=md-nav__link> thrift:// </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/protocol/rest/ title=rest:// class=md-nav__link> rest:// </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-9 type=checkbox id=nav-1-1-1-9> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-9> 注册中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=注册中心参考手册 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-9> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 注册中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/multicast/ title="Multicast 注册中心" class=md-nav__link> Multicast 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/zookeeper/ title="Zookeeper 注册中心" class=md-nav__link> Zookeeper 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/redis/ title="Redis 注册中心" class=md-nav__link> Redis 注册中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/registry/simple/ title="Simple 注册中心" class=md-nav__link> Simple 注册中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-10 type=checkbox id=nav-1-1-1-10> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-10> 元数据中心参考手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=元数据中心参考手册 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-10> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 元数据中心参考手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/metadata/metadata-redis/ title="Redis 元数据中心" class=md-nav__link> Redis 元数据中心 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/metadata/metadata-zookeeper/ title="Zookeeper 元数据中心" class=md-nav__link> Zookeeper 元数据中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/telnet/ title="telnet 命令参考手册" class=md-nav__link> telnet 命令参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/qos/ title=在线运维命令-QOS class=md-nav__link> 在线运维命令-QOS </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/references/maven/ title="maven 插件参考手册" class=md-nav__link> maven 插件参考手册 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/best-practice/ title=服务化最佳实践 class=md-nav__link> 服务化最佳实践 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/recommend/ title=推荐用法 class=md-nav__link> 推荐用法 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/capacity-plan/ title=容量规划 class=md-nav__link> 容量规划 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/perf-test/ title=性能测试报告 class=md-nav__link> 性能测试报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/covergence.md title=测试覆盖率报告 class=md-nav__link> 测试覆盖率报告 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-1-19 type=checkbox id=nav-1-1-1-19> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-1-19> 版本与升级 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=版本与升级 data-md-level=4> <label class=md-nav__title for=nav-1-1-1-19> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 版本与升级 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../2.7/user/versions/version-270/ title=2.7.x升级步骤及注意事项 class=md-nav__link> 2.7.x升级步骤及注意事项 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-2 type=checkbox id=nav-1-1-2> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-2> 开发手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发手册 data-md-level=3> <label class=md-nav__title for=nav-1-1-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/build.md title=源码构建 class=md-nav__link> 源码构建 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/design.md title=框架设计 class=md-nav__link> 框架设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/SPI.md title=扩展点加载 class=md-nav__link> 扩展点加载 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/implementation.md title=实现细节 class=md-nav__link> 实现细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-2-5 type=checkbox id=nav-1-1-2-5> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-2-5> SPI 扩展实现 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label="SPI 扩展实现" data-md-level=4> <label class=md-nav__title for=nav-1-1-2-5> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> SPI 扩展实现 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/protocol.md title=协议扩展 class=md-nav__link> 协议扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/filter.md title=调用拦截扩展 class=md-nav__link> 调用拦截扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/invoker-listener.md title=引用监听扩展 class=md-nav__link> 引用监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exporter-listener.md title=暴露监听扩展 class=md-nav__link> 暴露监听扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cluster.md title=集群扩展 class=md-nav__link> 集群扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/router.md title=路由扩展 class=md-nav__link> 路由扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/load-balance.md title=负载均衡扩展 class=md-nav__link> 负载均衡扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/merger.md title=合并结果扩展 class=md-nav__link> 合并结果扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/registry.md title=注册中心扩展 class=md-nav__link> 注册中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/monitor.md title=监控中心扩展 class=md-nav__link> 监控中心扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/extension-factory.md title=扩展点加载扩展 class=md-nav__link> 扩展点加载扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/proxy-factory.md title=动态代理扩展 class=md-nav__link> 动态代理扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/compiler.md title=编译器扩展 class=md-nav__link> 编译器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/dispatcher.md title=消息派发扩展 class=md-nav__link> 消息派发扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/threadpool.md title=线程池扩展 class=md-nav__link> 线程池扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/serialize.md title=序列化扩展 class=md-nav__link> 序列化扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/remoting.md title=网络传输扩展 class=md-nav__link> 网络传输扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/exchanger.md title=信息交换扩展 class=md-nav__link> 信息交换扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/networker.md title=组网扩展 class=md-nav__link> 组网扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/telnet-handler.md title="Telnet 命令扩展" class=md-nav__link> Telnet 命令扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/status-checker.md title=状态检查扩展 class=md-nav__link> 状态检查扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/container.md title=容器扩展 class=md-nav__link> 容器扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/page.md title=页面扩展 class=md-nav__link> 页面扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/cache.md title=缓存扩展 class=md-nav__link> 缓存扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/validation.md title=验证扩展 class=md-nav__link> 验证扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/logger-adapter.md title=日志适配扩展 class=md-nav__link> 日志适配扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/impls/config-center.md title=配置中心 class=md-nav__link> 配置中心 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contract.md title=公共契约 class=md-nav__link> 公共契约 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/coding.md title=编码约定 class=md-nav__link> 编码约定 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-2-8 type=checkbox id=nav-1-1-2-8> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-2-8> 设计原则 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=设计原则 data-md-level=4> <label class=md-nav__title for=nav-1-1-2-8> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 设计原则 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/code-detail.md title=魔鬼在细节 class=md-nav__link> 魔鬼在细节 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/general-knowledge.md title=一些设计上的基本常识 class=md-nav__link> 一些设计上的基本常识 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/expansibility.md title=谈谈扩充式扩展与增量式扩展 class=md-nav__link> 谈谈扩充式扩展与增量式扩展 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/configuration.md title=配置设计 class=md-nav__link> 配置设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/robustness.md title=设计实现的健壮性 class=md-nav__link> 设计实现的健壮性 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/dummy.md title=防痴呆设计 class=md-nav__link> 防痴呆设计 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/principals/extension.md title=扩展点重构 class=md-nav__link> 扩展点重构 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/release.md title=版本发布 class=md-nav__link> 版本发布 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/contribution.md title=贡献代码 class=md-nav__link> 贡献代码 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/checklist.md title=检查列表 class=md-nav__link> 检查列表 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/code-smell.md title=坏味道 class=md-nav__link> 坏味道 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../dev/TCK.md title=兼容性测试 class=md-nav__link> 兼容性测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1-3 type=checkbox id=nav-1-1-3> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-1-3> 管理者文档 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=管理者文档 data-md-level=3> <label class=md-nav__title for=nav-1-1-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 管理者文档 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/introduction.md title="Dubbo Admin介绍" class=md-nav__link> Dubbo Admin介绍 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceSearch.md title=服务搜索和详情 class=md-nav__link> 服务搜索和详情 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceGovernance.md title=服务治理 class=md-nav__link> 服务治理 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../admin/serviceTest.md title=服务测试 class=md-nav__link> 服务测试 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2> 3.0 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=3.0 data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 3.0 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-1 type=checkbox id=nav-1-2-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-1> 用户手册 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=用户手册 data-md-level=3> <label class=md-nav__title for=nav-1-2-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 用户手册 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2-1-1 type=checkbox id=nav-1-2-1-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1-2-1-1> 入门 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=入门 data-md-level=4> <label class=md-nav__title for=nav-1-2-1-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 入门 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/background/ title=背景 class=md-nav__link> 背景 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/background/ title=需求 class=md-nav__link> 需求 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/architecture/ title=架构 class=md-nav__link> 架构 </a> </li> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../user/preface/usage/ title=用法 class=md-nav__link> 用法 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 博客 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=博客 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 博客 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../blog/apache-dubbo-2019-2020/ title="2019-2020 回顾" class=md-nav__link> 2019-2020 回顾 </a> </li> </ul> </nav> </li> <!-- Currently active page --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class="md-nav__item md-nav__item--nested"> <!-- Active checkbox expands items contained within nested section --> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1> <!-- Expand active pages --> <label class=md-nav__link for=nav-1> 开发者指南 <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg> </span> </label> <nav class=md-nav aria-label=开发者指南 data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 开发者指南 </label> <ul class=md-nav__list data-md-scrollfix> <!-- Render nested item list --> <!-- Determine class according to level --> <!-- Main navigation item with nested items --> <li class=md-nav__item> <a href=../../../../developers/developers_dev/ title=开发者指引 class=md-nav__link> 开发者指引 </a> </li> </ul> </nav> </li> <!-- Currently active page --> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1.简介 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2.源码分析 </a> <nav class=md-nav aria-label=2.源码分析> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-randomloadbalance class=md-nav__link> 2.1 RandomLoadBalance </a> </li> <li class=md-nav__item> <a href=#22-leastactiveloadbalance class=md-nav__link> 2.2 LeastActiveLoadBalance </a> </li> <li class=md-nav__item> <a href=#23-consistenthashloadbalance class=md-nav__link> 2.3 ConsistentHashLoadBalance </a> </li> <li class=md-nav__item> <a href=#24-roundrobinloadbalance class=md-nav__link> 2.4 RoundRobinLoadBalance </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3.总结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/apache/dubbo-website/edit/master/zh-cn/docs/3.0/source_code_guide/loadbalance.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1>负载均衡</h1> <h2 id=1>1.简介<a class=headerlink href=#1 title="Permanent link">&para;</a></h2> <p>LoadBalance 中文意思为负载均衡，它的职责是将网络请求，或者其他形式的负载“均摊”到不同的机器上。避免集群中部分服务器压力过大，而另一些服务器比较空闲的情况。通过负载均衡，可以让每台服务器获取到适合自己处理能力的负载。在为高负载服务器分流的同时，还可以避免资源浪费，一举两得。负载均衡可分为软件负载均衡和硬件负载均衡。在我们日常开发中，一般很难接触到硬件负载均衡。但软件负载均衡还是可以接触到的，比如 Nginx。在 Dubbo 中，也有负载均衡的概念和相应的实现。Dubbo 需要对服务消费者的调用请求进行分配，避免少数服务提供者负载过大。服务提供者负载过大，会导致部分请求超时。因此将负载均衡到每个服务提供者上，是非常必要的。Dubbo 提供了4种负载均衡实现，分别是基于权重随机算法的 RandomLoadBalance、基于最少活跃调用数算法的 LeastActiveLoadBalance、基于 hash 一致性的 ConsistentHashLoadBalance，以及基于加权轮询算法的 RoundRobinLoadBalance。这几个负载均衡算法代码不是很长，但是想看懂也不是很容易，需要大家对这几个算法的原理有一定了解才行。如果不是很了解，也没不用太担心。我们会在分析每个算法的源码之前，对算法原理进行简单的讲解，帮助大家建立初步的印象。</p> <p>本系列文章在编写之初是基于 Dubbo 2.6.4 的，近期，Dubbo 2.6.5 发布了，其中就有针对对负载均衡部分的优化。因此我们在分析完 2.6.4 版本后的源码后，会另外分析 2.6.5 更新的部分。其他的就不多说了，进入正题吧。</p> <h2 id=2>2.源码分析<a class=headerlink href=#2 title="Permanent link">&para;</a></h2> <p>在 Dubbo 中，所有负载均衡实现类均继承自 AbstractLoadBalance，该类实现了 LoadBalance 接口，并封装了一些公共的逻辑。所以在分析负载均衡实现之前，先来看一下 AbstractLoadBalance 的逻辑。首先来看一下负载均衡的入口方法 select，如下：</p> <p><div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>select</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>invokers</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>invokers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span>
        <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=c1>// 如果 invokers 列表中仅有一个 Invoker，直接返回即可，无需进行负载均衡</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>

    <span class=c1>// 调用 doSelect 方法进行负载均衡，该方法为抽象方法，由子类实现</span>
    <span class=k>return</span> <span class=n>doSelect</span><span class=p>(</span><span class=n>invokers</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>invocation</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>protected</span> <span class=kd>abstract</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>);</span>
</code></pre></div> select 方法的逻辑比较简单，首先会检测 invokers 集合的合法性，然后再检测 invokers 集合元素数量。如果只包含一个 Invoker，直接返回该 Inovker 即可。如果包含多个 Invoker，此时需要通过负载均衡算法选择一个 Invoker。具体的负载均衡算法由子类实现，接下来章节会对这些子类一一进行详细分析。</p> <p>AbstractLoadBalance 除了实现了 LoadBalance 接口方法，还封装了一些公共逻辑，比如服务提供者权重计算逻辑。具体实现如下：</p> <p><div class=highlight><pre><span></span><code><span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getWeight</span><span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;?&gt;</span> <span class=n>invoker</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 从 url 中获取权重 weight 配置值</span>
    <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>Constants</span><span class=p>.</span><span class=na>WEIGHT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_WEIGHT</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// 获取服务提供者启动时间戳</span>
        <span class=kt>long</span> <span class=n>timestamp</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>REMOTE_TIMESTAMP_KEY</span><span class=p>,</span> <span class=mi>0</span><span class=n>L</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>timestamp</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=n>L</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 计算服务提供者运行时长</span>
            <span class=kt>int</span> <span class=n>uptime</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()</span> <span class=o>-</span> <span class=n>timestamp</span><span class=p>);</span>
            <span class=c1>// 获取服务预热时间，默认为10分钟</span>
            <span class=kt>int</span> <span class=n>warmup</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getParameter</span><span class=p>(</span><span class=n>Constants</span><span class=p>.</span><span class=na>WARMUP_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_WARMUP</span><span class=p>);</span>
            <span class=c1>// 如果服务运行时间小于预热时间，则重新计算服务权重，即降权</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>uptime</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>uptime</span> <span class=o>&lt;</span> <span class=n>warmup</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 重新计算服务权重</span>
                <span class=n>weight</span> <span class=o>=</span> <span class=n>calculateWarmupWeight</span><span class=p>(</span><span class=n>uptime</span><span class=p>,</span> <span class=n>warmup</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>weight</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>static</span> <span class=kt>int</span> <span class=nf>calculateWarmupWeight</span><span class=p>(</span><span class=kt>int</span> <span class=n>uptime</span><span class=p>,</span> <span class=kt>int</span> <span class=n>warmup</span><span class=p>,</span> <span class=kt>int</span> <span class=n>weight</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 计算权重，下面代码逻辑上形似于 (uptime / warmup) * weight。</span>
    <span class=c1>// 随着服务运行时间 uptime 增大，权重计算值 ww 会慢慢接近配置值 weight</span>
    <span class=kt>int</span> <span class=n>ww</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>((</span><span class=kt>float</span><span class=p>)</span> <span class=n>uptime</span> <span class=o>/</span> <span class=p>((</span><span class=kt>float</span><span class=p>)</span> <span class=n>warmup</span> <span class=o>/</span> <span class=p>(</span><span class=kt>float</span><span class=p>)</span> <span class=n>weight</span><span class=p>));</span>
    <span class=k>return</span> <span class=n>ww</span> <span class=o>&lt;</span> <span class=mi>1</span> <span class=o>?</span> <span class=mi>1</span> <span class=p>:</span> <span class=p>(</span><span class=n>ww</span> <span class=o>&gt;</span> <span class=n>weight</span> <span class=o>?</span> <span class=n>weight</span> <span class=p>:</span> <span class=n>ww</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> 上面是权重的计算过程，该过程主要用于保证当服务运行时长小于服务预热时间时，对服务进行降权，避免让服务在启动之初就处于高负载状态。服务预热是一个优化手段，与此类似的还有 JVM 预热。主要目的是让服务启动后“低功率”运行一段时间，使其效率慢慢提升至最佳状态。</p> <p>关于 AbstractLoadBalance 就先分析到这，接下来分析各个实现类的代码。首先，我们从 Dubbo 缺省的实现类 RandomLoadBalance 看起。</p> <h3 id=21-randomloadbalance>2.1 RandomLoadBalance<a class=headerlink href=#21-randomloadbalance title="Permanent link">&para;</a></h3> <p>RandomLoadBalance 是加权随机算法的具体实现，它的算法思想很简单。假设我们有一组服务器 servers = [A, B, C]，他们对应的权重为 weights = [5, 3, 2]，权重总和为10。现在把这些权重值平铺在一维坐标值上，[0, 5) 区间属于服务器 A，[5, 8) 区间属于服务器 B，[8, 10) 区间属于服务器 C。接下来通过随机数生成器生成一个范围在 [0, 10) 之间的随机数，然后计算这个随机数会落到哪个区间上。比如数字3会落到服务器 A 对应的区间上，此时返回服务器 A 即可。权重越大的机器，在坐标轴上对应的区间范围就越大，因此随机数生成器生成的数字就会有更大的概率落到此区间内。只要随机数生成器产生的随机数分布性很好，在经过多次选择后，每个服务器被选中的次数比例接近其权重比例。比如，经过一万次选择后，服务器 A 被选中的次数大约为5000次，服务器 B 被选中的次数约为3000次，服务器 C 被选中的次数约为2000次。</p> <p>以上就是 RandomLoadBalance 背后的算法思想，比较简单。下面开始分析源码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RandomLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;random&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>totalWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=kt>boolean</span> <span class=n>sameWeight</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
        <span class=c1>// 下面这个循环有两个作用，第一是计算总权重 totalWeight，</span>
        <span class=c1>// 第二是检测每个服务提供者的权重是否相同</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=c1>// 累加权重</span>
            <span class=n>totalWeight</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
            <span class=c1>// 检测当前服务提供者的权重与上一个服务提供者的权重是否相同，</span>
            <span class=c1>// 不相同的话，则将 sameWeight 置为 false。</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>sameWeight</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span>
                    <span class=o>&amp;&amp;</span> <span class=n>weight</span> <span class=o>!=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span> <span class=o>-</span> <span class=mi>1</span><span class=p>),</span> <span class=n>invocation</span><span class=p>))</span> <span class=p>{</span>
                <span class=n>sameWeight</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 下面的 if 分支主要用于获取随机数，并计算随机数落在哪个区间上</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>totalWeight</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>sameWeight</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 随机获取一个 [0, totalWeight) 区间内的数字</span>
            <span class=kt>int</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>);</span>
            <span class=c1>// 循环让 offset 数减去服务提供者权重值，当 offset 小于0时，返回相应的 Invoker。</span>
            <span class=c1>// 举例说明一下，我们有 servers = [A, B, C]，weights = [5, 3, 2]，offset = 7。</span>
            <span class=c1>// 第一次循环，offset - 5 = 2 &gt; 0，即 offset &gt; 5，</span>
            <span class=c1>// 表明其不会落在服务器 A 对应的区间上。</span>
            <span class=c1>// 第二次循环，offset - 3 = -1 &lt; 0，即 5 &lt; offset &lt; 8，</span>
            <span class=c1>// 表明其会落在服务器 B 对应的区间上</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 让随机值 offset 减去权重值</span>
                <span class=n>offset</span> <span class=o>-=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>offset</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// 返回相应的 Invoker</span>
                    <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 如果所有服务提供者权重值相同，此时直接随机返回一个即可</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>length</span><span class=p>));</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>RandomLoadBalance 的算法思想比较简单，在经过多次请求后，能够将调用请求按照权重值进行“均匀”分配。当然 RandomLoadBalance 也存在一定的缺点，当调用次数比较少时，Random 产生的随机数可能会比较集中，此时多数请求会落到同一台服务器上。这个缺点并不是很严重，多数情况下可以忽略。RandomLoadBalance 是一个简单，高效的负载均衡实现，因此 Dubbo 选择它作为缺省实现。</p> <p>关于 RandomLoadBalance 就先到这了，接下来分析 LeastActiveLoadBalance。</p> <h3 id=22-leastactiveloadbalance>2.2 LeastActiveLoadBalance<a class=headerlink href=#22-leastactiveloadbalance title="Permanent link">&para;</a></h3> <p>LeastActiveLoadBalance 翻译过来是最小活跃数负载均衡。活跃调用数越小，表明该服务提供者效率越高，单位时间内可处理更多的请求。此时应优先将请求分配给该服务提供者。在具体实现中，每个服务提供者对应一个活跃数 active。初始情况下，所有服务提供者活跃数均为0。每收到一个请求，活跃数加1，完成请求后则将活跃数减1。在服务运行一段时间后，性能好的服务提供者处理请求的速度更快，因此活跃数下降的也越快，此时这样的服务提供者能够优先获取到新的服务请求、这就是最小活跃数负载均衡算法的基本思想。除了最小活跃数，LeastActiveLoadBalance 在实现上还引入了权重值。所以准确的来说，LeastActiveLoadBalance 是基于加权最小活跃数算法实现的。举个例子说明一下，在一个服务提供者集群中，有两个性能优异的服务提供者。某一时刻它们的活跃数相同，此时 Dubbo 会根据它们的权重去分配请求，权重越大，获取到新请求的概率就越大。如果两个服务提供者权重相同，此时随机选择一个即可。关于 LeastActiveLoadBalance 的背景知识就先介绍到这里，下面开始分析源码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LeastActiveLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;leastactive&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Random</span> <span class=n>random</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=c1>// 最小的活跃数</span>
        <span class=kt>int</span> <span class=n>leastActive</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
        <span class=c1>// 具有相同“最小活跃数”的服务者提供者（以下用 Invoker 代称）数量</span>
        <span class=kt>int</span> <span class=n>leastCount</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> 
        <span class=c1>// leastIndexs 用于记录具有相同“最小活跃数”的 Invoker 在 invokers 列表中的下标信息</span>
        <span class=kt>int</span><span class=o>[]</span> <span class=n>leastIndexs</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>int</span><span class=o>[</span><span class=n>length</span><span class=o>]</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>totalWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=c1>// 第一个最小活跃数的 Invoker 权重值，用于与其他具有相同最小活跃数的 Invoker 的权重进行对比，</span>
        <span class=c1>// 以检测是否“所有具有相同最小活跃数的 Invoker 的权重”均相等</span>
        <span class=kt>int</span> <span class=n>firstWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=kt>boolean</span> <span class=n>sameWeight</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>

        <span class=c1>// 遍历 invokers 列表</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
            <span class=c1>// 获取 Invoker 对应的活跃数</span>
            <span class=kt>int</span> <span class=n>active</span> <span class=o>=</span> <span class=n>RpcStatus</span><span class=p>.</span><span class=na>getStatus</span><span class=p>(</span><span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>(),</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>()).</span><span class=na>getActive</span><span class=p>();</span>
            <span class=c1>// 获取权重 - ⭐️</span>
            <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>Constants</span><span class=p>.</span><span class=na>WEIGHT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_WEIGHT</span><span class=p>);</span>
            <span class=c1>// 发现更小的活跃数，重新开始</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>leastActive</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=o>||</span> <span class=n>active</span> <span class=o>&lt;</span> <span class=n>leastActive</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 使用当前活跃数 active 更新最小活跃数 leastActive</span>
                <span class=n>leastActive</span> <span class=o>=</span> <span class=n>active</span><span class=p>;</span>
                <span class=c1>// 更新 leastCount 为 1</span>
                <span class=n>leastCount</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
                <span class=c1>// 记录当前下标值到 leastIndexs 中</span>
                <span class=n>leastIndexs</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
                <span class=n>totalWeight</span> <span class=o>=</span> <span class=n>weight</span><span class=p>;</span>
                <span class=n>firstWeight</span> <span class=o>=</span> <span class=n>weight</span><span class=p>;</span>
                <span class=n>sameWeight</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>

            <span class=c1>// 当前 Invoker 的活跃数 active 与最小活跃数 leastActive 相同 </span>
            <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>==</span> <span class=n>leastActive</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 在 leastIndexs 中记录下当前 Invoker 在 invokers 集合中的下标</span>
                <span class=n>leastIndexs</span><span class=o>[</span><span class=n>leastCount</span><span class=o>++]</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
                <span class=c1>// 累加权重</span>
                <span class=n>totalWeight</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
                <span class=c1>// 检测当前 Invoker 的权重与 firstWeight 是否相等，</span>
                <span class=c1>// 不相等则将 sameWeight 置为 false</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>sameWeight</span> <span class=o>&amp;&amp;</span> <span class=n>i</span> <span class=o>&gt;</span> <span class=mi>0</span>
                    <span class=o>&amp;&amp;</span> <span class=n>weight</span> <span class=o>!=</span> <span class=n>firstWeight</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>sameWeight</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 当只有一个 Invoker 具有最小活跃数，此时直接返回该 Invoker 即可</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>leastCount</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndexs</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 有多个 Invoker 具有相同的最小活跃数，但它们之间的权重不同</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>sameWeight</span> <span class=o>&amp;&amp;</span> <span class=n>totalWeight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 随机生成一个 [0, totalWeight) 之间的数字</span>
            <span class=kt>int</span> <span class=n>offsetWeight</span> <span class=o>=</span> <span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>);</span>
            <span class=c1>// 循环让随机数减去具有最小活跃数的 Invoker 的权重值，</span>
            <span class=c1>// 当 offset 小于等于0时，返回相应的 Invoker</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>leastCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>int</span> <span class=n>leastIndex</span> <span class=o>=</span> <span class=n>leastIndexs</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span>
                <span class=c1>// 获取权重值，并让随机数减去权重值 - ⭐️</span>
                <span class=n>offsetWeight</span> <span class=o>-=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndex</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>offsetWeight</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
                    <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndex</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=c1>// 如果权重相同或权重为0时，随机返回一个 Invoker</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndexs</span><span class=o>[</span><span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>leastCount</span><span class=p>)</span><span class=o>]</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>上面代码的逻辑比较多，我们在代码中写了大量的注释，有帮助大家理解代码逻辑。下面简单总结一下以上代码所做的事情，如下：</p> <ol> <li>遍历 invokers 列表，寻找活跃数最小的 Invoker</li> <li>如果有多个 Invoker 具有相同的最小活跃数，此时记录下这些 Invoker 在 invokers 集合中的下标，并累加它们的权重，比较它们的权重值是否相等</li> <li>如果只有一个 Invoker 具有最小的活跃数，此时直接返回该 Invoker 即可</li> <li>如果有多个 Invoker 具有最小活跃数，且它们的权重不相等，此时处理方式和 RandomLoadBalance 一致</li> <li>如果有多个 Invoker 具有最小活跃数，但它们的权重相等，此时随机返回一个即可</li> </ol> <p>以上就是 LeastActiveLoadBalance 大致的实现逻辑，大家在阅读的源码的过程中要注意区分活跃数与权重这两个概念，不要混为一谈。</p> <p>以上分析是基于 Dubbo 2.6.4 版本进行的，由于近期 Dubbo 2.6.5 发布了，并对 LeastActiveLoadBalance 进行了一些修改，下面简单来介绍一下修改内容。回到上面的源码中，我们在上面的代码中标注了两个黄色的五角星⭐️。两处标记对应的代码分别如下：</p> <div class=highlight><pre><span></span><code><span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(),</span> <span class=n>Constants</span><span class=p>.</span><span class=na>WEIGHT_KEY</span><span class=p>,</span> <span class=n>Constants</span><span class=p>.</span><span class=na>DEFAULT_WEIGHT</span><span class=p>);</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=n>offsetWeight</span> <span class=o>-=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndex</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
</code></pre></div> <p>问题出在服务预热阶段，第一行代码直接从 url 中取权重值，未被降权过。第二行代码获取到的是经过降权后的权重。第一行代码获取到的权重值最终会被累加到权重总和 totalWeight 中，这个时候会导致一个问题。offsetWeight 是一个在 [0, totalWeight) 范围内的随机数，而它所减去的是经过降权的权重。很有可能在经过 leastCount 次运算后，offsetWeight 仍然是大于0的，导致无法选中 Invoker。这个问题对应的 issue 为 <a href=https://github.com/apache/dubbo/issues/904>#904</a>，并在 pull request <a href=https://github.com/apache/dubbo/pull/2172>#2172</a> 中被修复。具体的修复逻辑是将标注一处的代码修改为：</p> <div class=highlight><pre><span></span><code><span class=c1>// afterWarmup 等价于上面的 weight 变量，这样命名是为了强调该变量经过了 warmup 降权处理</span>
<span class=kt>int</span> <span class=n>afterWarmup</span> <span class=o>=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invoker</span><span class=p>,</span> <span class=n>invocation</span><span class=p>);</span>
</code></pre></div> <p>另外，2.6.4 版本中的 LeastActiveLoadBalance 还有一个缺陷，即当一组 Invoker 具有相同的最小活跃数，且其中一个 Invoker 的权重值为1，此时这个 Invoker 无法被选中。缺陷代码如下：</p> <div class=highlight><pre><span></span><code><span class=kt>int</span> <span class=n>offsetWeight</span> <span class=o>=</span> <span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>);</span>
<span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>leastCount</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>int</span> <span class=n>leastIndex</span> <span class=o>=</span> <span class=n>leastIndexs</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span>
    <span class=n>offsetWeight</span> <span class=o>-=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndex</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>offsetWeight</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>    <span class=c1>// ❌</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>leastIndex</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>问题出在了<code>offsetWeight &lt;= 0</code>上，举例说明，假设有一组 Invoker 的权重为 5、2、1，offsetWeight 最大值为 7。假设 offsetWeight = 7，你会发现，当 for 循环进行第二次遍历后 offsetWeight = 7 - 5 - 2 = 0，提前返回了。此时，此时权重为1的 Invoker 就没有机会被选中了。该问题在 Dubbo 2.6.5 中被修复了，修改后的代码如下：</p> <div class=highlight><pre><span></span><code><span class=kt>int</span> <span class=n>offsetWeight</span> <span class=o>=</span> <span class=n>random</span><span class=p>.</span><span class=na>nextInt</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</code></pre></div> <p>以上就是 Dubbo 2.6.5 对 LeastActiveLoadBalance 的更新，内容不是很多，先分析到这。接下来分析基于一致性 hash 思想的 ConsistentHashLoadBalance。</p> <h3 id=23-consistenthashloadbalance>2.3 ConsistentHashLoadBalance<a class=headerlink href=#23-consistenthashloadbalance title="Permanent link">&para;</a></h3> <p>一致性 hash 算法由麻省理工学院的 Karger 及其合作者于1997年提出的，算法提出之初是用于大规模缓存系统的负载均衡。它的工作过程是这样的，首先根据 ip 或者其他的信息为缓存节点生成一个 hash，并将这个 hash 投射到 [0, 2<sup>32</sup> - 1] 的圆环上。当有查询或写入请求时，则为缓存项的 key 生成一个 hash 值。然后查找第一个大于或等于该 hash 值的缓存节点，并到这个节点中查询或写入缓存项。如果当前节点挂了，则在下一次查询或写入缓存时，为缓存项查找另一个大于其 hash 值的缓存节点即可。大致效果如下图所示，每个缓存节点在圆环上占据一个位置。如果缓存项的 key 的 hash 值小于缓存节点 hash 值，则到该缓存节点中存储或读取缓存项。比如下面绿色点对应的缓存项将会被存储到 cache-2 节点中。由于 cache-3 挂了，原本应该存到该节点中的缓存项最终会存储到 cache-4 节点中。</p> <p><img alt src=../sources/images/consistent-hash.jpg></p> <p>下面来看看一致性 hash 在 Dubbo 中的应用。我们把上图的缓存节点替换成 Dubbo 的服务提供者，于是得到了下图：</p> <p><img alt src=../sources/images/consistent-hash-invoker.jpg></p> <p>这里相同颜色的节点均属于同一个服务提供者，比如 Invoker1-1，Invoker1-2，……, Invoker1-160。这样做的目的是通过引入虚拟节点，让 Invoker 在圆环上分散开来，避免数据倾斜问题。所谓数据倾斜是指，由于节点不够分散，导致大量请求落到了同一个节点上，而其他节点只会接收到了少量请求的情况。比如：</p> <p><img alt src=../sources/images/consistent-hash-data-incline.jpg></p> <p>如上，由于 Invoker-1 和 Invoker-2 在圆环上分布不均，导致系统中75%的请求都会落到 Invoker-1 上，只有 25% 的请求会落到 Invoker-2 上。解决这个问题办法是引入虚拟节点，通过虚拟节点均衡各个节点的请求量。</p> <p>到这里背景知识就普及完了，接下来开始分析源码。我们先从 ConsistentHashLoadBalance 的 doSelect 方法开始看起，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ConsistentHashLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>ConsistentHashSelector</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>selectors</span> <span class=o>=</span> 
        <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>ConsistentHashSelector</span><span class=o>&lt;?&gt;&gt;</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>methodName</span> <span class=o>=</span> <span class=n>RpcUtils</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getServiceKey</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>methodName</span><span class=p>;</span>

        <span class=c1>// 获取 invokers 原始的 hashcode</span>
        <span class=kt>int</span> <span class=n>identityHashCode</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>identityHashCode</span><span class=p>(</span><span class=n>invokers</span><span class=p>);</span>
        <span class=n>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>selector</span> <span class=o>=</span> <span class=p>(</span><span class=n>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>selectors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=c1>// 如果 invokers 是一个新的 List 对象，意味着服务提供者数量发生了变化，可能新增也可能减少了。</span>
        <span class=c1>// 此时 selector.identityHashCode != identityHashCode 条件成立</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>selector</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>selector</span><span class=p>.</span><span class=na>identityHashCode</span> <span class=o>!=</span> <span class=n>identityHashCode</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 创建新的 ConsistentHashSelector</span>
            <span class=n>selectors</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>new</span> <span class=n>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>invokers</span><span class=p>,</span> <span class=n>methodName</span><span class=p>,</span> <span class=n>identityHashCode</span><span class=p>));</span>
            <span class=n>selector</span> <span class=o>=</span> <span class=p>(</span><span class=n>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>selectors</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 调用 ConsistentHashSelector 的 select 方法选择 Invoker</span>
        <span class=k>return</span> <span class=n>selector</span><span class=p>.</span><span class=na>select</span><span class=p>(</span><span class=n>invocation</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{...}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，doSelect 方法主要做了一些前置工作，比如检测 invokers 列表是不是变动过，以及创建 ConsistentHashSelector。这些工作做完后，接下来开始调用 ConsistentHashSelector 的 select 方法执行负载均衡逻辑。在分析 select 方法之前，我们先来看一下一致性 hash 选择器 ConsistentHashSelector 的初始化过程，如下：</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ConsistentHashSelector</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

    <span class=c1>// 使用 TreeMap 存储 Invoker 虚拟节点</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>TreeMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>virtualInvokers</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>replicaNumber</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>identityHashCode</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=kt>int</span><span class=o>[]</span> <span class=n>argumentIndex</span><span class=p>;</span>

    <span class=n>ConsistentHashSelector</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>String</span> <span class=n>methodName</span><span class=p>,</span> <span class=kt>int</span> <span class=n>identityHashCode</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>this</span><span class=p>.</span><span class=na>virtualInvokers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TreeMap</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span><span class=p>();</span>
        <span class=k>this</span><span class=p>.</span><span class=na>identityHashCode</span> <span class=o>=</span> <span class=n>identityHashCode</span><span class=p>;</span>
        <span class=n>URL</span> <span class=n>url</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getUrl</span><span class=p>();</span>
        <span class=c1>// 获取虚拟节点数，默认为160</span>
        <span class=k>this</span><span class=p>.</span><span class=na>replicaNumber</span> <span class=o>=</span> <span class=n>url</span><span class=p>.</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span> <span class=s>&quot;hash.nodes&quot;</span><span class=p>,</span> <span class=mi>160</span><span class=p>);</span>
        <span class=c1>// 获取参与 hash 计算的参数下标值，默认对第一个参数进行 hash 运算</span>
        <span class=n>String</span><span class=o>[]</span> <span class=n>index</span> <span class=o>=</span> <span class=n>Constants</span><span class=p>.</span><span class=na>COMMA_SPLIT_PATTERN</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=n>url</span><span class=p>.</span><span class=na>getMethodParameter</span><span class=p>(</span><span class=n>methodName</span><span class=p>,</span> <span class=s>&quot;hash.arguments&quot;</span><span class=p>,</span> <span class=s>&quot;0&quot;</span><span class=p>));</span>
        <span class=n>argumentIndex</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>int</span><span class=o>[</span><span class=n>index</span><span class=p>.</span><span class=na>length</span><span class=o>]</span><span class=p>;</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>index</span><span class=p>.</span><span class=na>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>argumentIndex</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>index</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>String</span> <span class=n>address</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getAddress</span><span class=p>();</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>replicaNumber</span> <span class=o>/</span> <span class=mi>4</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 对 address + i 进行 md5 运算，得到一个长度为16的字节数组</span>
                <span class=kt>byte</span><span class=o>[]</span> <span class=n>digest</span> <span class=o>=</span> <span class=n>md5</span><span class=p>(</span><span class=n>address</span> <span class=o>+</span> <span class=n>i</span><span class=p>);</span>
                <span class=c1>// 对 digest 部分字节进行4次 hash 运算，得到四个不同的 long 型正整数</span>
                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>h</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>h</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=n>h</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                    <span class=c1>// h = 0 时，取 digest 中下标为 0 ~ 3 的4个字节进行位运算</span>
                    <span class=c1>// h = 1 时，取 digest 中下标为 4 ~ 7 的4个字节进行位运算</span>
                    <span class=c1>// h = 2, h = 3 时过程同上</span>
                    <span class=kt>long</span> <span class=n>m</span> <span class=o>=</span> <span class=n>hash</span><span class=p>(</span><span class=n>digest</span><span class=p>,</span> <span class=n>h</span><span class=p>);</span>
                    <span class=c1>// 将 hash 到 invoker 的映射关系存储到 virtualInvokers 中，</span>
                    <span class=c1>// virtualInvokers 需要提供高效的查询操作，因此选用 TreeMap 作为存储结构</span>
                    <span class=n>virtualInvokers</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=n>invoker</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ConsistentHashSelector 的构造方法执行了一系列的初始化逻辑，比如从配置中获取虚拟节点数以及参与 hash 计算的参数下标，默认情况下只使用第一个参数进行 hash。需要特别说明的是，ConsistentHashLoadBalance 的负载均衡逻辑只受参数值影响，具有相同参数值的请求将会被分配给同一个服务提供者。ConsistentHashLoadBalance 不 关系权重，因此使用时需要注意一下。</p> <p>在获取虚拟节点数和参数下标配置后，接下来要做的事情是计算虚拟节点 hash 值，并将虚拟节点存储到 TreeMap 中。到此，ConsistentHashSelector 初始化工作就完成了。接下来，我们来看看 select 方法的逻辑。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>select</span><span class=p>(</span><span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 将参数转为 key</span>
    <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>toKey</span><span class=p>(</span><span class=n>invocation</span><span class=p>.</span><span class=na>getArguments</span><span class=p>());</span>
    <span class=c1>// 对参数 key 进行 md5 运算</span>
    <span class=kt>byte</span><span class=o>[]</span> <span class=n>digest</span> <span class=o>=</span> <span class=n>md5</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
    <span class=c1>// 取 digest 数组的前四个字节进行 hash 运算，再将 hash 值传给 selectForKey 方法，</span>
    <span class=c1>// 寻找合适的 Invoker</span>
    <span class=k>return</span> <span class=n>selectForKey</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>digest</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>selectForKey</span><span class=p>(</span><span class=kt>long</span> <span class=n>hash</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// 到 TreeMap 中查找第一个节点值大于或等于当前 hash 的 Invoker</span>
    <span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Long</span><span class=p>,</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>entry</span> <span class=o>=</span> <span class=n>virtualInvokers</span><span class=p>.</span><span class=na>tailMap</span><span class=p>(</span><span class=n>hash</span><span class=p>,</span> <span class=kc>true</span><span class=p>).</span><span class=na>firstEntry</span><span class=p>();</span>
    <span class=c1>// 如果 hash 大于 Invoker 在圆环上最大的位置，此时 entry = null，</span>
    <span class=c1>// 需要将 TreeMap 的头节点赋值给 entry</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>entry</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>entry</span> <span class=o>=</span> <span class=n>virtualInvokers</span><span class=p>.</span><span class=na>firstEntry</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=c1>// 返回 Invoker</span>
    <span class=k>return</span> <span class=n>entry</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>如上，选择的过程相对比较简单了。首先是对参数进行 md5 以及 hash 运算，得到一个 hash 值。然后再拿这个值到 TreeMap 中查找目标 Invoker 即可。</p> <p>到此关于 ConsistentHashLoadBalance 就分析完了。在阅读 ConsistentHashLoadBalance 源码之前，大家一定要先补充背景知识，不然很难看懂代码逻辑。</p> <h3 id=24-roundrobinloadbalance>2.4 RoundRobinLoadBalance<a class=headerlink href=#24-roundrobinloadbalance title="Permanent link">&para;</a></h3> <p>本节，我们来看一下 Dubbo 中加权轮询负载均衡的实现 RoundRobinLoadBalance。在详细分析源码前，我们先来了解一下什么是加权轮询。这里从最简单的轮询开始讲起，所谓轮询是指将请求轮流分配给每台服务器。举个例子，我们有三台服务器 A、B、C。我们将第一个请求分配给服务器 A，第二个请求分配给服务器 B，第三个请求分配给服务器 C，第四个请求再次分配给服务器 A。这个过程就叫做轮询。轮询是一种无状态负载均衡算法，实现简单，适用于每台服务器性能相近的场景下。但现实情况下，我们并不能保证每台服务器性能均相近。如果我们将等量的请求分配给性能较差的服务器，这显然是不合理的。因此，这个时候我们需要对轮询过程进行加权，以调控每台服务器的负载。经过加权后，每台服务器能够得到的请求数比例，接近或等于他们的权重比。比如服务器 A、B、C 权重比为 5:2:1。那么在8次请求中，服务器 A 将收到其中的5次请求，服务器 B 会收到其中的2次请求，服务器 C 则收到其中的1次请求。</p> <p>以上就是加权轮询的算法思想，搞懂了这个思想，接下来我们就可以分析源码了。我们先来看一下 2.6.4 版本的 RoundRobinLoadBalance。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RoundRobinLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;roundrobin&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span> <span class=n>sequences</span> <span class=o>=</span> 
        <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// key = 全限定类名 + &quot;.&quot; + 方法名，比如 com.xxx.DemoService.sayHello</span>
        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getServiceKey</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=c1>// 最大权重</span>
        <span class=kt>int</span> <span class=n>maxWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=c1>// 最小权重</span>
        <span class=kt>int</span> <span class=n>minWeight</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>IntegerWrapper</span><span class=o>&gt;</span> <span class=n>invokerToWeightMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>IntegerWrapper</span><span class=o>&gt;</span><span class=p>();</span>
        <span class=c1>// 权重总和</span>
        <span class=kt>int</span> <span class=n>weightSum</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>

        <span class=c1>// 下面这个循环主要用于查找最大和最小权重，计算权重总和等</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=c1>// 获取最大和最小权重</span>
            <span class=n>maxWeight</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWeight</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
            <span class=n>minWeight</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>minWeight</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 将 weight 封装到 IntegerWrapper 中</span>
                <span class=n>invokerToWeightMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=k>new</span> <span class=n>IntegerWrapper</span><span class=p>(</span><span class=n>weight</span><span class=p>));</span>
                <span class=c1>// 累加权重</span>
                <span class=n>weightSum</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 查找 key 对应的对应 AtomicPositiveInteger 实例，为空则创建。</span>
        <span class=c1>// 这里可以把 AtomicPositiveInteger 看成一个黑盒，大家只要知道</span>
        <span class=c1>// AtomicPositiveInteger 用于记录服务的调用编号即可。至于细节，</span>
        <span class=c1>// 大家如果感兴趣，可以自行分析</span>
        <span class=n>AtomicPositiveInteger</span> <span class=n>sequence</span> <span class=o>=</span> <span class=n>sequences</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sequence</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>sequences</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>new</span> <span class=n>AtomicPositiveInteger</span><span class=p>());</span>
            <span class=n>sequence</span> <span class=o>=</span> <span class=n>sequences</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 获取当前的调用编号</span>
        <span class=kt>int</span> <span class=n>currentSequence</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>.</span><span class=na>getAndIncrement</span><span class=p>();</span>
        <span class=c1>// 如果最小权重小于最大权重，表明服务提供者之间的权重是不相等的</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>maxWeight</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>minWeight</span> <span class=o>&lt;</span> <span class=n>maxWeight</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 使用调用编号对权重总和进行取余操作</span>
            <span class=kt>int</span> <span class=n>mod</span> <span class=o>=</span> <span class=n>currentSequence</span> <span class=o>%</span> <span class=n>weightSum</span><span class=p>;</span>
            <span class=c1>// 进行 maxWeight 次遍历</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>maxWeight</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// 遍历 invokerToWeightMap</span>
                <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>IntegerWrapper</span><span class=o>&gt;</span> <span class=n>each</span> <span class=p>:</span> <span class=n>invokerToWeightMap</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
                    <span class=c1>// 获取 Invoker</span>
                    <span class=kd>final</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>k</span> <span class=o>=</span> <span class=n>each</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
                    <span class=c1>// 获取权重包装类 IntegerWrapper</span>
                    <span class=kd>final</span> <span class=n>IntegerWrapper</span> <span class=n>v</span> <span class=o>=</span> <span class=n>each</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>

                    <span class=c1>// 如果 mod = 0，且权重大于0，此时返回相应的 Invoker</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>mod</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>v</span><span class=p>.</span><span class=na>getValue</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                        <span class=k>return</span> <span class=n>k</span><span class=p>;</span>
                    <span class=p>}</span>

                    <span class=c1>// mod != 0，且权重大于0，此时对权重和 mod 分别进行自减操作</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>getValue</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                        <span class=n>v</span><span class=p>.</span><span class=na>decrement</span><span class=p>();</span>
                        <span class=n>mod</span><span class=o>--</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 服务提供者之间的权重相等，此时通过轮询选择 Invoker</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currentSequence</span> <span class=o>%</span> <span class=n>length</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=c1>// IntegerWrapper 是一个 int 包装类，主要包含了一个自减方法。</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>IntegerWrapper</span> <span class=p>{</span>
        <span class=kd>private</span> <span class=kt>int</span> <span class=n>value</span><span class=p>;</span>

        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>decrement</span><span class=p>()</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=na>value</span><span class=o>--</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 省略部分代码</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>如上，RoundRobinLoadBalance 的每行代码都不是很难理解，但是将它们组合在一起之后，就不是很好理解了。所以下面我们举例进行说明，假设我们有三台服务器 servers = [A, B, C]，对应的权重为 weights = [2, 5, 1]。接下来对上面的逻辑进行简单的模拟。</p> <p>mod = 0：满足条件，此时直接返回服务器 A</p> <p>mod = 1：需要进行一次递减操作才能满足条件，此时返回服务器 B</p> <p>mod = 2：需要进行两次递减操作才能满足条件，此时返回服务器 C</p> <p>mod = 3：需要进行三次递减操作才能满足条件，经过递减后，服务器权重为 [1, 4, 0]，此时返回服务器 A</p> <p>mod = 4：需要进行四次递减操作才能满足条件，经过递减后，服务器权重为 [0, 4, 0]，此时返回服务器 B</p> <p>mod = 5：需要进行五次递减操作才能满足条件，经过递减后，服务器权重为 [0, 3, 0]，此时返回服务器 B</p> <p>mod = 6：需要进行六次递减操作才能满足条件，经过递减后，服务器权重为 [0, 2, 0]，此时返回服务器 B</p> <p>mod = 7：需要进行七次递减操作才能满足条件，经过递减后，服务器权重为 [0, 1, 0]，此时返回服务器 B</p> <p>经过8次调用后，我们得到的负载均衡结果为 [A, B, C, A, B, B, B, B]，次数比 A:B:C = 2:5:1，等于权重比。当 sequence = 8 时，mod = 0，此时重头再来。从上面的模拟过程可以看出，当 mod &gt;= 3 后，服务器 C 就不会被选中了，因为它的权重被减为0了。当 mod &gt;= 4 后，服务器 A 的权重被减为0，此后 A 就不会再被选中。</p> <p>以上是 2.6.4 版本的 RoundRobinLoadBalance 分析过程，2.6.4 版本的 RoundRobinLoadBalance 在某些情况下存在着比较严重的性能问题，该问题最初是在 <a href=https://github.com/apache/dubbo/issues/2578>issue #2578</a> 中被反馈出来。问题出在了 Invoker 的返回时机上，RoundRobinLoadBalance 需要在<code>mod == 0 &amp;&amp; v.getValue() &gt; 0</code> 条件成立的情况下才会被返回相应的 Invoker。假如 mod 很大，比如 10000，50000，甚至更大时，doSelect 方法需要进行很多次计算才能将 mod 减为0。由此可知，doSelect 的效率与 mod 有关，时间复杂度为 O(mod)。mod 又受最大权重 maxWeight 的影响，因此当某个服务提供者配置了非常大的权重，此时 RoundRobinLoadBalance 会产生比较严重的性能问题。这个问题被反馈后，社区很快做了回应。并对 RoundRobinLoadBalance 的代码进行了重构，将时间复杂度优化至了常量级别。这个优化可以说很好了，下面我们来学习一下优化后的代码。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RoundRobinLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;roundrobin&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span> <span class=n>sequences</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span> <span class=n>indexSeqs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>AtomicPositiveInteger</span><span class=o>&gt;</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getServiceKey</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>length</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
        <span class=kt>int</span> <span class=n>maxWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=kt>int</span> <span class=n>minWeight</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>.</span><span class=na>MAX_VALUE</span><span class=p>;</span>
        <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokerToWeightList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>

        <span class=c1>// 查找最大和最小权重</span>
        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
            <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>),</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=n>maxWeight</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=n>maxWeight</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
            <span class=n>minWeight</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>minWeight</span><span class=p>,</span> <span class=n>weight</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>weight</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>invokerToWeightList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 获取当前服务对应的调用序列对象 AtomicPositiveInteger</span>
        <span class=n>AtomicPositiveInteger</span> <span class=n>sequence</span> <span class=o>=</span> <span class=n>sequences</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>sequence</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 创建 AtomicPositiveInteger，默认值为0</span>
            <span class=n>sequences</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>new</span> <span class=n>AtomicPositiveInteger</span><span class=p>());</span>
            <span class=n>sequence</span> <span class=o>=</span> <span class=n>sequences</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=c1>// 获取下标序列对象 AtomicPositiveInteger</span>
        <span class=n>AtomicPositiveInteger</span> <span class=n>indexSeq</span> <span class=o>=</span> <span class=n>indexSeqs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>indexSeq</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 创建 AtomicPositiveInteger，默认值为 -1</span>
            <span class=n>indexSeqs</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>new</span> <span class=n>AtomicPositiveInteger</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>));</span>
            <span class=n>indexSeq</span> <span class=o>=</span> <span class=n>indexSeqs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>maxWeight</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>minWeight</span> <span class=o>&lt;</span> <span class=n>maxWeight</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>length</span> <span class=o>=</span> <span class=n>invokerToWeightList</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
            <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
                <span class=kt>int</span> <span class=n>index</span> <span class=o>=</span> <span class=n>indexSeq</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>()</span> <span class=o>%</span> <span class=n>length</span><span class=p>;</span>
                <span class=kt>int</span> <span class=n>currentWeight</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>.</span><span class=na>get</span><span class=p>()</span> <span class=o>%</span> <span class=n>maxWeight</span><span class=p>;</span>

                <span class=c1>// 每循环一轮（index = 0），重新计算 currentWeight</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>index</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                    <span class=n>currentWeight</span> <span class=o>=</span> <span class=n>sequence</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>()</span> <span class=o>%</span> <span class=n>maxWeight</span><span class=p>;</span>
                <span class=p>}</span>

                <span class=c1>// 检测 Invoker 的权重是否大于 currentWeight，大于则返回</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>getWeight</span><span class=p>(</span><span class=n>invokerToWeightList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>),</span> <span class=n>invocation</span><span class=p>)</span> <span class=o>&gt;</span> <span class=n>currentWeight</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>return</span> <span class=n>invokerToWeightList</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>index</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=c1>// 所有 Invoker 权重相等，此时进行普通的轮询即可</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sequence</span><span class=p>.</span><span class=na>incrementAndGet</span><span class=p>()</span> <span class=o>%</span> <span class=n>length</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>上面代码的逻辑是这样的，每进行一轮循环，重新计算 currentWeight。如果当前 Invoker 权重大于 currentWeight，则返回该 Invoker。下面举例说明，假设服务器 [A, B, C] 对应权重 [5, 2, 1]。</p> <p>第一轮循环，currentWeight = 1，可返回 A 和 B</p> <p>第二轮循环，currentWeight = 2，返回 A</p> <p>第三轮循环，currentWeight = 3，返回 A</p> <p>第四轮循环，currentWeight = 4，返回 A</p> <p>第五轮循环，currentWeight = 0，返回 A, B, C</p> <p>如上，这里的一轮循环是指 index 再次变为0所经历过的循环，这里可以把 index = 0 看做是一轮循环的开始。每一轮循环的次数与 Invoker 的数量有关，Invoker 数量通常不会太多，所以我们可以认为上面代码的时间复杂度为常数级。</p> <p>重构后的 RoundRobinLoadBalance 看起来已经很不错了，但是在代码更新不久后，很快又被重构了。这次重构原因是新的 RoundRobinLoadBalance 在某些情况下选出的服务器序列不够均匀。比如，服务器 [A, B, C] 对应权重 [5, 1, 1]。进行7次负载均衡后，选择出来的序列为 [A, A, A, A, A, B, C]。前5个请求全部都落在了服务器 A上，这将会使服务器 A 短时间内接收大量的请求，压力陡增。而 B 和 C 此时无请求，处于空闲状态。而我们期望的结果是这样的 [A, A, B, A, C, A, A]，不同服务器可以穿插获取请求。为了增加负载均衡结果的平滑性，社区再次对 RoundRobinLoadBalance 的实现进行了重构，这次重构参考自 Nginx 的平滑加权轮询负载均衡。每个服务器对应两个权重，分别为 weight 和 currentWeight。其中 weight 是固定的，currentWeight 会动态调整，初始值为0。当有新的请求进来时，遍历服务器列表，让它的 currentWeight 加上自身权重。遍历完成后，找到最大的 currentWeight，并将其减去权重总和，然后返回相应的服务器即可。</p> <p>上面描述不是很好理解，下面还是举例进行说明。这里仍然使用服务器 [A, B, C] 对应权重 [5, 1, 1] 的例子说明，现在有7个请求依次进入负载均衡逻辑，选择过程如下：</p> <table> <thead> <tr> <th>请求编号</th> <th>currentWeight 数组</th> <th>选择结果</th> <th>减去权重总和后的 currentWeight 数组</th> </tr> </thead> <tbody> <tr> <td>1</td> <td>[5, 1, 1]</td> <td>A</td> <td>[-2, 1, 1]</td> </tr> <tr> <td>2</td> <td>[3, 2, 2]</td> <td>A</td> <td>[-4, 2, 2]</td> </tr> <tr> <td>3</td> <td>[1, 3, 3]</td> <td>B</td> <td>[1, -4, 3]</td> </tr> <tr> <td>4</td> <td>[6, -3, 4]</td> <td>A</td> <td>[-1, -3, 4]</td> </tr> <tr> <td>5</td> <td>[4, -2, 5]</td> <td>C</td> <td>[4, -2, -2]</td> </tr> <tr> <td>6</td> <td>[9, -1, -1]</td> <td>A</td> <td>[2, -1, -1]</td> </tr> <tr> <td>7</td> <td>[7, 0, 0]</td> <td>A</td> <td>[0, 0, 0]</td> </tr> </tbody> </table> <p>如上，经过平滑性处理后，得到的服务器序列为 [A, A, B, A, C, A, A]，相比之前的序列 [A, A, A, A, A, B, C]，分布性要好一些。初始情况下 currentWeight = [0, 0, 0]，第7个请求处理完后，currentWeight 再次变为 [0, 0, 0]。</p> <p>以上就是平滑加权轮询的计算过程，接下来，我们来看看 Dubbo-2.6.5 是如何实现上面的计算过程的。</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RoundRobinLoadBalance</span> <span class=kd>extends</span> <span class=n>AbstractLoadBalance</span> <span class=p>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>NAME</span> <span class=o>=</span> <span class=s>&quot;roundrobin&quot;</span><span class=p>;</span>

    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=n>RECYCLE_PERIOD</span> <span class=o>=</span> <span class=mi>60000</span><span class=p>;</span>

    <span class=kd>protected</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>WeightedRoundRobin</span> <span class=p>{</span>
        <span class=c1>// 服务提供者权重</span>
        <span class=kd>private</span> <span class=kt>int</span> <span class=n>weight</span><span class=p>;</span>
        <span class=c1>// 当前权重</span>
        <span class=kd>private</span> <span class=n>AtomicLong</span> <span class=n>current</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicLong</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
        <span class=c1>// 最后一次更新时间</span>
        <span class=kd>private</span> <span class=kt>long</span> <span class=n>lastUpdate</span><span class=p>;</span>

        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setWeight</span><span class=p>(</span><span class=kt>int</span> <span class=n>weight</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>this</span><span class=p>.</span><span class=na>weight</span> <span class=o>=</span> <span class=n>weight</span><span class=p>;</span>
            <span class=c1>// 初始情况下，current = 0</span>
            <span class=n>current</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=kd>public</span> <span class=kt>long</span> <span class=nf>increaseCurrent</span><span class=p>()</span> <span class=p>{</span>
            <span class=c1>// current = current + weight；</span>
            <span class=k>return</span> <span class=n>current</span><span class=p>.</span><span class=na>addAndGet</span><span class=p>(</span><span class=n>weight</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>sel</span><span class=p>(</span><span class=kt>int</span> <span class=n>total</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// current = current - total;</span>
            <span class=n>current</span><span class=p>.</span><span class=na>addAndGet</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span> <span class=o>*</span> <span class=n>total</span><span class=p>);</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=c1>// 嵌套 Map 结构，存储的数据结构示例如下：</span>
    <span class=c1>// {</span>
    <span class=c1>//     &quot;UserService.query&quot;: {</span>
    <span class=c1>//         &quot;url1&quot;: WeightedRoundRobin@123, </span>
    <span class=c1>//         &quot;url2&quot;: WeightedRoundRobin@456, </span>
    <span class=c1>//     },</span>
    <span class=c1>//     &quot;UserService.update&quot;: {</span>
    <span class=c1>//         &quot;url1&quot;: WeightedRoundRobin@123, </span>
    <span class=c1>//         &quot;url2&quot;: WeightedRoundRobin@456,</span>
    <span class=c1>//     }</span>
    <span class=c1>// }</span>
    <span class=c1>// 最外层为服务类名 + 方法名，第二层为 url 到 WeightedRoundRobin 的映射关系。</span>
    <span class=c1>// 这里我们可以将 url 看成是服务提供者的 id</span>
    <span class=kd>private</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;&gt;</span> <span class=n>methodWeightMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;&gt;</span><span class=p>();</span>

    <span class=c1>// 原子更新锁</span>
    <span class=kd>private</span> <span class=n>AtomicBoolean</span> <span class=n>updateLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>AtomicBoolean</span><span class=p>();</span>

    <span class=nd>@Override</span>
    <span class=kd>protected</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>doSelect</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;&gt;</span> <span class=n>invokers</span><span class=p>,</span> <span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=n>Invocation</span> <span class=n>invocation</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getUrl</span><span class=p>().</span><span class=na>getServiceKey</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot;.&quot;</span> <span class=o>+</span> <span class=n>invocation</span><span class=p>.</span><span class=na>getMethodName</span><span class=p>();</span>
        <span class=c1>// 获取 url 到 WeightedRoundRobin 映射表，如果为空，则创建一个新的</span>
        <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=n>methodWeightMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>map</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>methodWeightMap</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;</span><span class=p>());</span>
            <span class=n>map</span> <span class=o>=</span> <span class=n>methodWeightMap</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=kt>int</span> <span class=n>totalWeight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
        <span class=kt>long</span> <span class=n>maxCurrent</span> <span class=o>=</span> <span class=n>Long</span><span class=p>.</span><span class=na>MIN_VALUE</span><span class=p>;</span>

        <span class=c1>// 获取当前时间</span>
        <span class=kt>long</span> <span class=n>now</span> <span class=o>=</span> <span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span>
        <span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>selectedInvoker</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
        <span class=n>WeightedRoundRobin</span> <span class=n>selectedWRR</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

        <span class=c1>// 下面这个循环主要做了这样几件事情：</span>
        <span class=c1>//   1. 遍历 Invoker 列表，检测当前 Invoker 是否有</span>
        <span class=c1>//      相应的 WeightedRoundRobin，没有则创建</span>
        <span class=c1>//   2. 检测 Invoker 权重是否发生了变化，若变化了，</span>
        <span class=c1>//      则更新 WeightedRoundRobin 的 weight 字段</span>
        <span class=c1>//   3. 让 current 字段加上自身权重，等价于 current += weight</span>
        <span class=c1>//   4. 设置 lastUpdate 字段，即 lastUpdate = now</span>
        <span class=c1>//   5. 寻找具有最大 current 的 Invoker，以及 Invoker 对应的 WeightedRoundRobin，</span>
        <span class=c1>//      暂存起来，留作后用</span>
        <span class=c1>//   6. 计算权重总和</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>Invoker</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>invoker</span> <span class=p>:</span> <span class=n>invokers</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>String</span> <span class=n>identifyString</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>.</span><span class=na>getUrl</span><span class=p>().</span><span class=na>toIdentityString</span><span class=p>();</span>
            <span class=n>WeightedRoundRobin</span> <span class=n>weightedRoundRobin</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>identifyString</span><span class=p>);</span>
            <span class=kt>int</span> <span class=n>weight</span> <span class=o>=</span> <span class=n>getWeight</span><span class=p>(</span><span class=n>invoker</span><span class=p>,</span> <span class=n>invocation</span><span class=p>);</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>weight</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>weight</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=c1>// 检测当前 Invoker 是否有对应的 WeightedRoundRobin，没有则创建</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>weightedRoundRobin</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>weightedRoundRobin</span> <span class=o>=</span> <span class=k>new</span> <span class=n>WeightedRoundRobin</span><span class=p>();</span>
                <span class=c1>// 设置 Invoker 权重</span>
                <span class=n>weightedRoundRobin</span><span class=p>.</span><span class=na>setWeight</span><span class=p>(</span><span class=n>weight</span><span class=p>);</span>
                <span class=c1>// 存储 url 唯一标识 identifyString 到 weightedRoundRobin 的映射关系</span>
                <span class=n>map</span><span class=p>.</span><span class=na>putIfAbsent</span><span class=p>(</span><span class=n>identifyString</span><span class=p>,</span> <span class=n>weightedRoundRobin</span><span class=p>);</span>
                <span class=n>weightedRoundRobin</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>identifyString</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=c1>// Invoker 权重不等于 WeightedRoundRobin 中保存的权重，说明权重变化了，此时进行更新</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>weight</span> <span class=o>!=</span> <span class=n>weightedRoundRobin</span><span class=p>.</span><span class=na>getWeight</span><span class=p>())</span> <span class=p>{</span>
                <span class=n>weightedRoundRobin</span><span class=p>.</span><span class=na>setWeight</span><span class=p>(</span><span class=n>weight</span><span class=p>);</span>
            <span class=p>}</span>

            <span class=c1>// 让 current 加上自身权重，等价于 current += weight</span>
            <span class=kt>long</span> <span class=n>cur</span> <span class=o>=</span> <span class=n>weightedRoundRobin</span><span class=p>.</span><span class=na>increaseCurrent</span><span class=p>();</span>
            <span class=c1>// 设置 lastUpdate，表示近期更新过</span>
            <span class=n>weightedRoundRobin</span><span class=p>.</span><span class=na>setLastUpdate</span><span class=p>(</span><span class=n>now</span><span class=p>);</span>
            <span class=c1>// 找出最大的 current </span>
            <span class=k>if</span> <span class=p>(</span><span class=n>cur</span> <span class=o>&gt;</span> <span class=n>maxCurrent</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>maxCurrent</span> <span class=o>=</span> <span class=n>cur</span><span class=p>;</span>
                <span class=c1>// 将具有最大 current 权重的 Invoker 赋值给 selectedInvoker</span>
                <span class=n>selectedInvoker</span> <span class=o>=</span> <span class=n>invoker</span><span class=p>;</span>
                <span class=c1>// 将 Invoker 对应的 weightedRoundRobin 赋值给 selectedWRR，留作后用</span>
                <span class=n>selectedWRR</span> <span class=o>=</span> <span class=n>weightedRoundRobin</span><span class=p>;</span>
            <span class=p>}</span>

            <span class=c1>// 计算权重总和</span>
            <span class=n>totalWeight</span> <span class=o>+=</span> <span class=n>weight</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// 对 &lt;identifyString, WeightedRoundRobin&gt; 进行检查，过滤掉长时间未被更新的节点。</span>
        <span class=c1>// 该节点可能挂了，invokers 中不包含该节点，所以该节点的 lastUpdate 长时间无法被更新。</span>
        <span class=c1>// 若未更新时长超过阈值后，就会被移除掉，默认阈值为60秒。</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>updateLock</span><span class=p>.</span><span class=na>get</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>invokers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>!=</span> <span class=n>map</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>updateLock</span><span class=p>.</span><span class=na>compareAndSet</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=kc>true</span><span class=p>))</span> <span class=p>{</span>
                <span class=k>try</span> <span class=p>{</span>
                    <span class=n>ConcurrentMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;</span> <span class=n>newMap</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;</span><span class=p>();</span>
                    <span class=c1>// 拷贝</span>
                    <span class=n>newMap</span><span class=p>.</span><span class=na>putAll</span><span class=p>(</span><span class=n>map</span><span class=p>);</span>

                    <span class=c1>// 遍历修改，即移除过期记录</span>
                    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;&gt;</span> <span class=n>it</span> <span class=o>=</span> <span class=n>newMap</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span>
                    <span class=k>while</span> <span class=p>(</span><span class=n>it</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span> <span class=p>{</span>
                        <span class=n>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>WeightedRoundRobin</span><span class=o>&gt;</span> <span class=n>item</span> <span class=o>=</span> <span class=n>it</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
                        <span class=k>if</span> <span class=p>(</span><span class=n>now</span> <span class=o>-</span> <span class=n>item</span><span class=p>.</span><span class=na>getValue</span><span class=p>().</span><span class=na>getLastUpdate</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>RECYCLE_PERIOD</span><span class=p>)</span> <span class=p>{</span>
                            <span class=n>it</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
                        <span class=p>}</span>
                    <span class=p>}</span>

                    <span class=c1>// 更新引用</span>
                    <span class=n>methodWeightMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>newMap</span><span class=p>);</span>
                <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
                    <span class=n>updateLock</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=p>(</span><span class=n>selectedInvoker</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
            <span class=c1>// 让 current 减去权重总和，等价于 current -= totalWeight</span>
            <span class=n>selectedWRR</span><span class=p>.</span><span class=na>sel</span><span class=p>(</span><span class=n>totalWeight</span><span class=p>);</span>
            <span class=c1>// 返回具有最大 current 的 Invoker</span>
            <span class=k>return</span> <span class=n>selectedInvoker</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=c1>// should not happen here</span>
        <span class=k>return</span> <span class=n>invokers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>以上就是 Dubbo-2.6.5 版本的 RoundRobinLoadBalance，大家如果能够理解平滑加权轮询算法的计算过程，再配合代码中注释，理解上面的代码应该不难。</p> <h2 id=3>3.总结<a class=headerlink href=#3 title="Permanent link">&para;</a></h2> <p>本篇文章对 Dubbo 中的几种负载均衡实现进行了详细的分析，内容比较多，大家慢慢消化。理解负载均衡代码逻辑的关键之处在于对背景知识的理解，因此大家在阅读源码前，务必先了解每种负载均衡对应的背景知识。</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/squidfunk target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://gitter.im/squidfunk/mkdocs-material target=_blank rel=noopener title=gitter.im class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 384 512"><path d="M66.4 322.5H16V0h50.4v322.5zM166.9 76.1h-50.4V512h50.4V76.1zm100.6 0h-50.4V512h50.4V76.1zM368 76h-50.4v247H368V76z"/></svg> </a> <a href=https://hub.docker.com/r/squidfunk/mkdocs-material/ target=_blank rel=noopener title=hub.docker.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 640 512"><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg> </a> <a href=https://twitter.com/squidfunk target=_blank rel=noopener title=twitter.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://linkedin.com/in/squidfunk/ target=_blank rel=noopener title=linkedin.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg> </a> <a href=https://instagram.com/squidfunk target=_blank rel=noopener title=instagram.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/vendor.d1f5a259.min.js></script> <script src=../../../../assets/javascripts/bundle.d5fec882.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c"}</script> <script>
        app = initialize({
          base: "../../../..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../../../../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>